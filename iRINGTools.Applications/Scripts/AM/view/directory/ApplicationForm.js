/*
 * File: Scripts/AM/view/directory/ApplicationForm.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('AM.view.directory.ApplicationForm', {
    extend: 'Ext.form.Panel',
    alias: 'widget.applicationform',

    requires: [
    'AM.view.directory.DataLayerCombo',
    'Ext.ux.form.CheckboxListCombo'
  ],

    record: '',
    node: '',
    border: true,
    bodyStyle: 'padding:10px 5px 0',
    method: 'POST',
    url: 'directory/application',

    initComponent: function () {
        var me = this;

        me.initialConfig = Ext.apply({
            method: 'POST',
            url: 'directory/application'
        }, me.initialConfig);

        Ext.applyIf(me, {
            defaults: {
                msgTarget: 'side',
                anchor: '100%'
            },
            dockedItems: [
        {
            xtype: 'toolbar',
            dock: 'bottom',
            items: [
            {
                xtype: 'tbfill'
            },
            {
                xtype: 'button',
                handler: function (button, event) {
                    me.onSave();
                },
                text: 'Ok'
            },
            {
                xtype: 'button',
                handler: function (button, event) {
                    me.onReset();
                },
                text: 'Cancel'
            }
          ]
        }
      ],
            items: [
        {
            xtype: 'hiddenfield',
            itemId: 'state',
            name: 'state'
        },
        {
            xtype: 'textfield',
            fieldLabel: 'Application Name',
            name: 'displayName',
            allowBlank: false
        },
        {
            xtype: 'textfield',
            fieldLabel: 'Internal Name',
            name: 'internalName',
            allowBlank: false
        },
        {
            xtype: 'textareafield',
            fieldLabel: 'Description',
            name: 'description'
        },
        {
            name: 'dataLayerCombo',
            xtype: 'combobox',
            fieldLabel: 'Data Layer',
            store: 'DataLayerStore',
            queryMode: 'local',
            autoSelect: false,
            displayField: 'name',
            valueField: 'assembly'
        },
        {
            xtype: 'checkboxlistcombo',
            width: 180,
            multiSelect: true,
            name: 'ResourceGroups',
            itemId: 'ResourceGroupId',
            fieldLabel: 'Groups for the User:',
            displayField: 'groupName',
            autoSelect: false,
            queryMode: 'remote',
            valueField: 'groupId',
            emptyText: 'Select Groups For The  User'
        },
        {
            xtype: 'container',
            layout: {
                align: 'stretch',
                type: 'hbox'
            },
            items: [
            {
                xtype: 'label',
                flex: 1,
                style: {
                    font: 'normal 12px tahoma, arial, helvetica, sans-serif;'
                },
                text: 'Settings:'
            },
            {
                xtype: 'label',
                flex: 1,
                style: {
                    font: 'normal 12px tahoma, arial, helvetica, sans-serif;'
                },
                text: 'Name'
            },
            {
                xtype: 'label',
                flex: 1.5,
                style: {
                    font: 'normal 12px tahoma, arial, helvetica, sans-serif;'
                },
                text: 'Value'
            },
            {
                xtype: 'button',
                action: 'addsettings',
                width: 50,
                text: 'Add',
                tooltip: 'Click to Add settings'
            }
          ]
        },
        {
            xtype: 'fieldset',
            border: false,
            name: 'fldsetcontainer',
            height: 200,
            id: 'settingfieldset',
            autoScroll: true
        }
      ]
        });

        me.callParent(arguments);
    },

    onSave: function () {
        var me = this;
        var win = me.up('window');
        var form = me.getForm();
        var state = form.findField('state').getValue();
        var appSettingsItems = me.items.map['settingfieldset'].items.items;
        var appSettingStore = Ext.create('Ext.data.Store', { fields: ['key', 'value'] });

        Ext.each(appSettingsItems, function (appSetting) {
            var settingCombo = appSetting.items.items[0];
            var storeIndex = settingCombo.getStore().find(settingCombo.displayField, settingCombo.rawValue);

            var appSettingName = settingCombo.getStore().getAt(storeIndex).get(settingCombo.displayField);
            var appSettingValue = appSetting.items.items[1].getValue();

            appSettingStore.add({ key: appSettingName, value: appSettingValue });
        });

        var node = me.node;
        var ResourceGroups = me.getForm().findField('ResourceGroups').getValue();

        if (form.isValid()) {
            if (ResourceGroups != '') {
                me.getForm().submit({
                    waitMsg: 'Saving Data...',
                    method: 'POST',
                    params: {
                        record: node.get('record'),
                        applicationSettings: Ext.encode(Ext.pluck(appSettingStore.data.items, 'data'))
                    },
                    success: function (response, request) {
                        var objResponseText = Ext.JSON.decode(request.response.responseText);

                        if (objResponseText["message"] == "duplicateApplication") {
                            showDialog(400, 50, 'Alert', "Application with this name already exists", Ext.Msg.OK, null);
                            return;
                        }

                        win.fireEvent('save', me);

                        var currentNode;

                        if (state == 'new') {
                            currentNode = node;
                        }
                        else {
                            currentNode = node.parentNode;
                        }

                        while (currentNode.firstChild) {
                            currentNode.removeChild(currentNode.firstChild);
                        }

                        var index = 0;

                        Ext.each(Ext.JSON.decode(request.response.responseText).nodes, function (newNode) {
                            currentNode.insertChild(index, newNode);
                            index++;
                        });

                        me.setLoading(false);

                        if (objResponseText["message"] == "applicationAdded") {

                            Ext.example.msg('Notification', 'Application added successfully!');
                        }
                        if (objResponseText["message"] == "applicationUpdated") {

                            Ext.example.msg('Notification', 'Application updated successfully!');
                        }
                    },
                    failure: function (response, request) {
                        var resp = Ext.decode(request.response.responseText);

                        var userMsg = resp['message'];
                        var detailMsg = resp['stackTraceDescription'];
                        var expPanel = Ext.widget('exceptionpanel', { title: 'Error Notification' });
                        Ext.ComponentQuery.query('#expValue', expPanel)[0].setValue(userMsg);
                        Ext.ComponentQuery.query('#expValue2', expPanel)[0].setValue(detailMsg);
                    }
                });
            }
            else {
                showDialog(400, 50, 'Alert', "Select atleast one Group before saving", Ext.Msg.OK, null);
            }
        }
        else {
            Ext.widget('messagepanel', { title: 'Warning', msg: 'Please complete all required fields.' });
            return;
        }
    },

    onReset: function () {
        var me = this;
        var win = me.up('window');
        win.fireEvent('Cancel', me);
    }

});