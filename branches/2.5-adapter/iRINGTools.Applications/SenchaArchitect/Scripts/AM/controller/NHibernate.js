/*
 * File: Scripts/AM/controller/NHibernate.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('AM.controller.NHibernate', {
  extend: 'Ext.app.Controller',

  requires: [
    'AM.view.nhibernate.Utility'
  ],

  dataTypes: '',
  models: [
    'AvailItemsModel',
    'TableSelectModel',
    'RelationNameModel',
    'PropertyMapModel',
    'MultiSelect'
  ],
  stores: [
    'AvailItemsStore',
    'ProviderStore',
    'NHibernateTreeStore',
    'MultiStore',
    'RelatedObjectStore',
    'RelationsStore'
  ],
  views: [
    'nhibernate.ConnectionStringForm',
    'nhibernate.RelationsForm',
    'nhibernate.SelectTablesForm',
    'nhibernate.MultiSelectionGrid',
    'nhibernate.NhibernatePanel',
    'nhibernate.PropertyGrid',
    'nhibernate.DataObjectForm',
    'nhibernate.DataKeyForm',
    'nhibernate.NhibernateTree',
    'nhibernate.SelectPropertiesForm',
    'nhibernate.SelectDataKeysForm',
    'nhibernate.SetPropertyForm',
    'nhibernate.SetRelationForm',
    'nhibernate.RelationsGrid',
    'nhibernate.MultiSelectComponentGrid'
  ],

  refs: [
    {
      autoCreate: true,
      forceCreate: true,
      ref: 'selectTablesForm',
      selector: 'selecttablesform',
      xtype: 'selecttablesform'
    },
    {
      autoCreate: true,
      forceCreate: true,
      ref: 'connectionStringForm',
      selector: 'connectionstringform',
      xtype: 'connectionstringform'
    },
    {
      autoCreate: true,
      forceCreate: true,
      ref: 'dataObjectForm',
      selector: 'dataobjectform',
      xtype: 'dataobjectform'
    },
    {
      autoCreate: true,
      forceCreate: true,
      ref: 'dataKeyForm',
      selector: 'datakeyform',
      xtype: 'datakeyform'
    },
    {
      autoCreate: true,
      forceCreate: true,
      ref: 'selectKeyFieldsForm',
      selector: 'selectdatakeysform',
      xtype: 'selectdatakeysform'
    },
    {
      autoCreate: true,
      forceCreate: true,
      ref: 'selectPropertiesForm',
      selector: 'selectpropertiesform',
      xtype: 'selectpropertiesform'
    },
    {
      autoCreate: true,
      forceCreate: true,
      ref: 'dataPropertyForm',
      selector: 'setpropertyform',
      xtype: 'setpropertyform'
    },
    {
      autoCreate: true,
      forceCreate: true,
      ref: 'relationsForm',
      selector: 'relationsform',
      xtype: 'relationsform'
    },
    {
      autoCreate: true,
      forceCreate: true,
      ref: 'setRelationForm',
      selector: 'setRelationForm',
      xtype: 'setrelationform'
    },
    {
      ref: 'dirTree',
      selector: 'viewport > directorypanel > directorytree',
      xtype: 'directorytree'
    },
    {
      ref: 'mainContent',
      selector: 'viewport > centerpanel > contentpanel',
      xtype: 'contentpanel'
    }
  ],

  onSaveDbObjectTree: function(button, e, eOpts) {
    var me = this;
    var content = this.getMainContent();
    content.body.mask();
    var nhPanel = button.up('nhibernatepanel');

    var dbObjectsTree = nhPanel.down('nhibernatetree');
    var gridSelected = dbObjectsTree.selectedTables;
    var dirNode = me.getDirNode(dbObjectsTree.dirNode);

    if(gridSelected.length === 0) {
      gridSelected = dirNode.data.record.dbInfo.dbTableNames.items;
    }
    var contextName = dirNode.parentNode.data.text;//dirNode.data.record.context;
    var endpoint = dirNode.data.record.Name;//dirNode.data.record.endpoint;
    var baseUrl = dirNode.data.record.BaseUrl;
    dirNode.data.record.dbInfo.dbProvider = dirNode.data.record.dbDict.Provider;//dbPro;
    dirNode.data.record.dbInfo.dbSchema = dirNode.data.record.dbDict.SchemaName//dbSch;
    var rootNode = dbObjectsTree.getRootNode();
    var treeProperty = me.getJsonTree(rootNode, dirNode, gridSelected);
    treeProperty.schemaName= dirNode.data.record.dbDict.SchemaName;//dbSch;
    Ext.Ajax.request({
      url: 'AdapterManager/Trees',//'NHibernate/Trees',
      timeout: 600000,
      method: 'POST',
      params: {
        scope: contextName,
        app: endpoint,
        baseUrl: baseUrl,
        tree: Ext.JSON.encode(treeProperty)
      },
      success: function (response, request) {
        var rtext = response.responseText;
        var error = 'SUCCESS = FALSE';
        var index = rtext.toUpperCase().indexOf(error);
        if (index == -1) {
          //showDialog(400, 100, 'Saving Result', 'Configuration has been saved successfully.', Ext.Msg.OK, null);
          var navpanel = me.getDirTree();
          navpanel.onReload(content);
          //content.body.unmask();
        }
        else {
          var msg = rtext.substring(index + error.length + 2, rtext.length - 1);
          showDialog(400, 100, 'Saving Result - Error', msg, Ext.Msg.OK, null);
          content.body.unmask();
        }
      },
      failure: function (response, request) {
        showDialog(660, 300, 'Saving Result', 'An error has occurred while saving the configuration.', Ext.Msg.OK, null);
        content.body.unmask();
      }
    });
  },

  onSaveDataObject: function(button, e, eOpts) {

    var me = this; 
    var form = button.up('dataobjectform');
    var panel = form.up('nhibernatepanel');
    var tree = panel.down('nhibernatetree');
    var treeNode = tree.getSelectedNode();
    var dirNode = me.getDirNode(tree.dirNode);
    var dbDict = dirNode.data.record.dbDict;
    var relationFolderNode;
    if (treeNode) {
      var treeNodeProps = treeNode.raw.properties;//treeNode.data.property;
      var objectNameField = form.getForm().findField('objectName');
      var objNam = objectNameField.getValue();

      if (objectNameField.validate())
      treeNodeProps.objectName = objNam;
      else {
        showDialog(400, 100, 'Warning', "Object Name is not valid. A valid object name should start with alphabet or \"_\", and follow by any number of \"_\", alphabet, or number characters", Ext.Msg.OK, null);
        return;
      }

      var oldObjNam = treeNodeProps.objectName;
      treeNodeProps.tableName = form.getForm().findField('tableName').getValue();
      treeNodeProps.objectName = objNam;
      treeNodeProps.keyDelimeter = form.getForm().findField('keyDelimeter').getValue();
      treeNodeProps.description = form.getForm().findField('description').getValue();

      for (var ijk = 0; ijk < dbDict.dataObjects.length; ijk++) {
        var dataObject = dbDict.dataObjects[ijk];
        if (treeNode.data.text.toUpperCase() != dataObject.objectName.toUpperCase())
        continue;

        dataObject.objectName = objNam;
        //alert('in loop..desc..'+form.getForm().findField('description').getValue());
        dataObject.description = form.getForm().findField('description').getValue();
        dataObject.keyDelimeter = form.getForm().findField('keyDelimeter').getValue();
      }

      treeNode.set('text', objNam);
      var rootNode = tree.getRootNode();

      for (var i = 0; i < rootNode.childNodes.length; i++) {
        var folderNode = rootNode.childNodes[i];
        var folderNodeProp;
        if(folderNode.data.property!=undefined)
        folderNodeProp = folderNode.data.property;
        else
        folderNodeProp = folderNode.raw.properties;

        if (folderNode.childNodes[2])
        relationFolderNode = folderNode.childNodes[2];
        else
        relationFolderNode = folderNode.attributes.children[2];

        if (!relationFolderNode)
        continue;

        if (relationFolderNode.childNodes)
        var relChildenNodes = relationFolderNode.childNodes;
        else
        var relChildenNodes = relationFolderNode.children;

        if (relChildenNodes) {
          for (var k = 0; k < relChildenNodes.length; k++) {
            var relationNode = relChildenNodes[k];

            if (relationNode.data.text === '')//if (relationNode.text === '')
            continue;

            //if (relationNode.data)
            //var relationNodeAttr = relationNode.data
            var relationNodeAttr = relationNode.raw;
            var relObjNam = relationNodeAttr.relatedObjectName;
            if (relObjNam.toLowerCase() != objNam.toLowerCase() && relObjNam.toLowerCase() == oldObjNam.toLowerCase())
            relationNodeAttr.relatedObjectName = objNam;

            if (relationNodeAttr.relatedObjMap) {
              var relatedObjPropMap = relationNodeAttr.relatedObjMap;

              for (var iki = 0; iki < relatedObjPropMap.length; iki++) {
                if (relatedObjPropMap[iki].relatedObjName.toLowerCase() == oldObjNam.toLowerCase())
                relatedObjPropMap[iki].relatedObjName = objNam;
              }
            }
          }
        }
      }
    }
  },

  onResetDataObject: function(button, e, eOpts) {
    var me = this;
    var form = button.up('dataobjectform');
    var panel = form.up('nhibernatepanel');
    var tree = panel.down('nhibernatetree');
    var dirNode = me.getDirNode(tree.dirNode);
    var dbDict = dirNode.data.record.dbDict;
    var treeNode = tree.getSelectedNode();
    var dObject;
    Ext.each(dbDict.dataObjects, function (dataObject) {
      //if(dataObject.objectName == treeNode.data.property.objectName)
      if(dataObject.objectName == treeNode.raw.properties.objectName)
      dObject = dataObject;
    });

    /*if (treeNode.data.property) {
    form.getForm().findField('objectName').setValue(treeNode.data.record.Name);
    form.getForm().findField('objectNamespace').setValue(dObject.objectNamespace);
    form.getForm().findField('keyDelimiter').setValue(dObject.keyDelimeter);
    form.getForm().findField('description').setValue(dObject.description);
    }*/

    if (dObject) {
      form.getForm().findField('objectName').setValue(dObject.objectName);
      form.getForm().findField('objectNamespace').setValue(dObject.objectNamespace);
      form.getForm().findField('keyDelimeter').setValue(dObject.keyDelimeter);
      form.getForm().findField('description').setValue(dObject.description);
    }

    var nameField = form.getForm().findField('objectName');
    var objectName = nameField.getValue();

    /*if (nameField.validate()) {
    treeNode.data.property.objectName = objectName;
    treeNode.set('text', objectName);
    }*/

  },

  onSaveKeyProperties: function(button, e, eOpts) {

    var me = this;
    var content = this.getMainContent();
    var panel = button.up('nhibernatepanel');
    var dbObjectsTree = panel.down('nhibernatetree');
    var treeStore = dbObjectsTree.getStore();
    var treeNode = treeStore.getNodeById(panel.treeNode.internalId);
    var rootNode = dbObjectsTree.getRootNode();
    var dirNode = me.getDirNode(dbObjectsTree.dirNode);
    var form = panel.down('selectdatakeysform');
    //var objectGrid =  form.down('multiselectcomponentgrid').items.items[2];//form.down('multiselectiongrid');
    //var boundlist = objectGrid.items.items[0].items.items[2].items.items[0].items.items[0];
    var selected = form.down('multiselectcomponentgrid').items.items[2].items.items[0].items.items[2].store.data.items;//objectGrid.getSelections(boundlist);//objectGrid.getSelectionModel().getSelection();
    var selectValues = [];
    Ext.each(selected, function(item) {
      selectValues.push(item.data.text);
    });

    var keysNode = panel.treeNode;
    var propertiesNode = keysNode.parentNode.childNodes[1];
    //var hiddenRootNode = propertiesNode.raw.hiddenNodes.hiddenNode;

    for (var i = 0; i < keysNode.childNodes.length; i++) {
      var found = false;

      for (var j = 0; j < selectValues.length; j++) {
        if (selectValues[j].toLowerCase() == keysNode.childNodes[i].data.text.toLowerCase()) {
          found = true;
          break;
        }
      }

      if (!found) {
        if (keysNode.childNodes[i].data.property)
        var properties = keysNode.childNodes[i].data.property;

        if (properties) {
          delete properties.keyType;
          properties.nullable = false;
          var newKeyNode = {
            text: keysNode.childNodes[i].data.text,//utilsObj.deletedRecords[i].data.text,
            property: properties,//utilsObj.deletedRecords[i].data.property,
            type: "dataProperty",
            hidden: false,
            leaf: true,
            iconCls: 'treeProperty'
          };
          keysNode.removeChild(keysNode.childNodes[i], false);
          i--;
        }
        //keysNode.parentNode.childNodes[1].appendChild(keysNode.childNodes[i]);

        //keysNode.childNodes[i].data.property.nullable = true;
        //delete keysNode.childNodes[i].data.property.keyType;
        panel.treeNode.parentNode.childNodes[1].appendChild(newKeyNode); 

        //panel.treeNode.removeChild(keysNode.childNodes[i], false);
        //i--;
        //break;
      }
    }

    var nodeChildren = [];
    for (var j = 0; j < keysNode.childNodes.length; j++)
    nodeChildren.push(keysNode.childNodes[j].data.text);

    for (var j = 0; j < selectValues.length; j++) {
      var found = false;
      for (var i = 0; i < nodeChildren.length; i++) {
        if (selectValues[j].toLowerCase() == nodeChildren[i].toLowerCase()) {
          found = true;
          break;
        }
      }
      var newKeyNode;
      if (!found) {


        for (var jj = 0; jj < propertiesNode.childNodes.length; jj++) {
          //for (var jj = 0; jj < propertiesNode.data.children.length; jj++) {
          if (propertiesNode.childNodes[jj].data.text.toLowerCase() == selectValues[j].toLowerCase()) {
            var properties = propertiesNode.childNodes[jj].data.property;//propertiesNode.data.children[jj].property;
            properties.keyType = 'assigned';
            properties.nullable = false;
            newKeyNode = {
              text: selectValues[j],
              type: "keyProperty",
              leaf: true,
              iconCls: 'treeKey',
              hidden: false,
              property: properties
            };
            keysNode.appendChild(newKeyNode);
            var rec;
            for(var k = 0;k<propertiesNode.childNodes.length;k++)
            if(propertiesNode.childNodes[k].data.text == selectValues[j])
            rec = propertiesNode.childNodes[k];
            //propertiesNode.removeChild(propertiesNode.childNodes[jj], false);
            propertiesNode.removeChild(rec, false);
            break;
          }
        }

        /* for (var kk = 0; kk < hiddenRootNode.children.length; kk++) {
        if (hiddenRootNode.children[kk].text.toLowerCase() == selectValues[j].toLowerCase()) {
        var properties = hiddenRootNode.children[kk].property;
        properties.keyType = 'assigned';
        properties.nullable = false;
        newKeyNode = {
        text: selectValues[j],
        type: "keyProperty",
        leaf: true,
        iconCls: 'treeKey',
        hidden: false,
        property: properties
        };
        keysNode.appendChild(newKeyNode);
        hiddenRootNode.children.splice(kk, 1);
        kk--;
        break;
        }
        }
        newKeyNode.dirty = true;*/
      }
    }
    //Code to remove non select key form key object.
    /*var founded;
    if(keysNode.childNodes.length > selectValues.length){
    for (var j = 0; j < keysNode.childNodes.length; j++){
    founded = false;
    for (var k = 0; k <selectValues.length ; k++){
    if (selectValues[k].toLowerCase() == nodeChildren[j].toLowerCase()) {
    founded = true;
    break
    }
    }
    if(!founded){
    keysNode.removeChild(keysNode.childNodes[j], false);
    }
    }

    }*/
    if (!keysNode.isExpanded())
    keysNode.expand();

  },

  onSaveDataProperties: function(button, e, eOpts) {

    var me = this;
    var content = this.getMainContent();
    var panel = button.up('nhibernatepanel');
    var dbObjectsTree = panel.down('nhibernatetree');
    var treeStore = dbObjectsTree.getStore();
    var treeNode = treeStore.getNodeById(panel.treeNode.internalId);
    var rootNode = dbObjectsTree.getRootNode();
    var dirNode = me.getDirNode(dbObjectsTree.dirNode);
    var form = panel.down('selectpropertiesform');
    //var objectGrid = form.down('multiselectcomponentgrid').items.items[2];//form.down('multiselectiongrid');
    //var boundlist = objectGrid.items.items[0].items.items[2].items.items[0].items.items[0];
    var selected = form.down('multiselectcomponentgrid').items.items[2].items.items[0].items.items[2].store.data.items;//objectGrid.getSelectionModel().getSelection();
    var available = form.down('multiselectcomponentgrid').items.items[2].items.items[0].items.items[0].store.data.items;
    var selectValues = [];
    Ext.each(selected, function(item) {
      selectValues.push(item.data.text);
    });

    var shownProperty = [];
    var availItems = [];
    //var hiddenRootNode = treeNode.raw.hiddenNodes.hiddenNode;
    var hiddenRootNode;
    for (var indexOfProperty = 0; indexOfProperty < node.childNodes.length; indexOfProperty++) {
      !me.hasShown(shownProperty, node.childNodes[indexOfProperty].text)
      shownProperty.push(node.childNodes[indexOfProperty].text);
      indexOfProperty++;
    }

    var selectedItems = [];
    Ext.each(node.childNodes, function (node) {
      selectedItems.push(node.data.text);
    });

    /*Ext.each(hiddenRootNode.children, function (node) {
    availItems.push(node.text);
    });
    */

    //var hiddenRootNode = treeNode.raw.hiddenNodes.hiddenNode;
    var hiddenRootNode;
    var indexHidden;

    for (var i = 0; i < treeNode.childNodes.length; i++) {
      var found = false;

      for (var j = 0; j < selectValues.length; j++) {
        if (selectValues[j].toLowerCase() == treeNode.childNodes[i].data.text.toLowerCase()) {
          found = true;
          break;
        }
      }

      if (!found) {
        utilsObj.deletedRecords.push(treeNode.childNodes[i]);
        treeNode.removeChild(treeNode.childNodes[i], false);
        i--;
      }
    }
    for (var j = 0; j < selectValues.length; j++) {
      found = false;

      for (var l = 0; l < treeNode.childNodes.length; l++) {
        if (selectValues[j].toLowerCase() == treeNode.childNodes[l].data.text.toLowerCase()) {
          found = true;
          break;
        }
      }

      /*for (var k = 0; k < hiddenRootNode.children.length; k++) {
      if (selectValues[j].toLowerCase() == hiddenRootNode.children[k].text.toLowerCase()) {
      indexHidden = k;
      break;
      }
      }*/
      if (!found){
        var propertyToAdd;
        for(var i=0;i<treeNode.data.children.length;i++){
          if(treeNode.data.children[i].text == selectValues[j])
          propertyToAdd = treeNode.data.children[i];
        }
        //if(utilsObj.deletedRecords.length>0){
        /*for (var kk = 0;kk<utilsObj.deletedRecords.length;kk++){
        for (var jj = 0;jj<utilsObj.deletedRecords.length;jj++){
        if(utilsObj.deletedRecords[kk].data.text == utilsObj.deletedRecords[jj].data.text && kk!=jj){
        utilsObj.deletedRecords.splice(jj,1)
        }
        }
        }*/
        // for (var i = 0;i<utilsObj.deletedRecords.length;i++)
        //{
        //if(selectValues[j] == utilsObj.deletedRecords[i].data.text){
        treeNode.appendChild({
          text: propertyToAdd.text,//utilsObj.deletedRecords[i].data.text,
          property: propertyToAdd.property,//utilsObj.deletedRecords[i].data.property,
          type: "dataProperty",
          hidden: false,
          leaf: true,
          iconCls: 'treeProperty'
        });
        //}
        //}
        //}
      }


      /* if (!found && indexHidden > -1) {
      treeNode.appendChild({
      text: hiddenRootNode.children[indexHidden].text,
      property: hiddenRootNode.children[indexHidden].property,
      type: "dataProperty",
      hidden: false,
      leaf: true,
      iconCls: 'treeProperty'
      });
      hiddenRootNode.children.splice(indexHidden, 1);
      }*/
    } 
    if (!treeNode.isExpanded())
    treeNode.expand();


  },

  onEditDbConnection: function(button, e, eOpts) {
    var me = this;
    var panel = button.up('nhibernatepanel');
    me.showConnectionStringForm(panel);
  },

  onResetKeyProperties: function(button, e, eOpts) {

    var me = this;
    var form = button.up('selectdatakeysform');
    var grid = form.down('multiselectiongrid');

    var panel = form.up('nhibernatepanel');
    var dataTree = panel.down('nhibernatetree');
    var dirNode = me.getDirNode(dataTree.dirNode);
    var rootNode = dataTree.getRootNode();
    var dataNode = dataTree.getSelectedNode();
    var selectKeys = [];
    var availTableName = [];
    var found = false;
    var repeatItem;

    for (var i = 0; i < dataNode.childNodes.length; i++) {
      var keyText = dataNode.childNodes[i].data.text;
      selectKeys.push(keyText);
    }

    var itemSelecter = form.down('#multiselectcomponentgrid');
    itemSelecter.items.items[2].bindStore(grid.getStore());
    if(selectKeys){
      var records = [];
      for(var jj=0;jj<selectKeys.length;jj++){
        for(var  kk = 0;kk<grid.getStore().data.length;kk++){
          if(selectKeys[jj] == grid.getStore().data.items[kk].data.text){
            records.push(grid.getStore().data.items[kk]);
            itemSelecter.items.items[2].items.items[0].items.items[0].getStore().remove(grid.getStore().data.items[kk]);
            break;
          }
        }     
      }

      itemSelecter.items.items[2].items.items[0].items.items[2].getStore().add(records);
    }


    //grid.selectItems(selectTableNamesSingle);
  },

  onSaveKeyProperty: function(button, e, eOpts) {

    var me = this;
    form = button.up('datakeyform');
    var panel = form.up('nhibernatepanel');
    var tree = panel.down('nhibernatetree');
    var node = tree.getSelectedNode();
    var propertyNameField = form.getForm().findField('propertyName');
    var propertyName = propertyNameField.getValue();

    if (propertyNameField.validate()) {
      node.data.property.propertyName = propertyName;
      node.set('text', propertyName);
    }
    else {
      showDialog(400, 100, 'Warning', "Key Property Name is not valid. A valid key property name should start with alphabet or \"_\", and follow by any number of \"_\", alphabet, or number characters", Ext.Msg.OK, null);
    }         
  },

  onResetKeyProperty: function(button, e, eOpts) {
    var me = this;
    form = button.up('datakeyform');
    var panel = form.up('nhibernatepanel');
    var tree = panel.down('nhibernatetree');
    var node = tree.getSelectedNode();
    var propertyNameField = form.getForm().findField('propertyName');
    propertyNameField.setValue(node.data.property.propertyName);
    var propertyName = propertyNameField.getValue();

    if (propertyNameField.validate()) {
      node.data.property.propertyName = propertyName;
      node.set('text', propertyName);
    }
    else {
      showDialog(400, 100, 'Warning', "Key Property Name is not valid. A valid key property name should start with alphabet or \"_\", and follow by any number of \"_\", alphabet, or number characters", Ext.Msg.OK, null);
    } 

  },

  onSaveDataProperty: function(button, e, eOpts) {
    var me = this;
    form = button.up('setpropertyform');
    var panel = form.up('nhibernatepanel');
    var tree = panel.down('nhibernatetree');
    var node = tree.getSelectedNode();
    var propertyNameField = form.getForm().findField('propertyName');
    var isHidden = form.getForm().findField('isHidden').getValue();
    var propertyName = propertyNameField.getValue();
    if (propertyNameField.validate()) {
      node.data.property.propertyName = propertyName;
      node.data.property.isHidden = isHidden;
      //node.data.property.columnName = propertyName;
      node.set('text', propertyName);
    }
    else {
      showDialog(400, 100, 'Warning', "Property Name is not valid. A valid property name should start with alphabet or \"_\", and follow by any number of \"_\", alphabet, or number characters", Ext.Msg.OK, null);
    }         
  },

  onResetDataProperty: function(button, e, eOpts) {
    var me = this;
    form = button.up('setpropertyform');
    var panel = form.up('nhibernatepanel');
    var tree = panel.down('nhibernatetree');

    var node = tree.getSelectedNode();
    var propertyNameField = form.getForm().findField('propertyName');
    propertyNameField.setValue(node.data.property.columnName);
    var propertyName = propertyNameField.getValue();
    if (propertyNameField.validate()) {
      node.data.property.propertyName = propertyName;
      node.set('text', propertyName);
    }
    else {
      showDialog(400, 100, 'Warning', "Property Name is not valid. A valid property name should start with alphabet or \"_\", and follow by any number of \"_\", alphabet, or number characters", Ext.Msg.OK, null);
    } 

  },

  onTreepanelItemClick: function(dataview, record, item, index, e, eOpts) {
    var me = this;
    var panel = dataview.up('nhibernatepanel');
    var dataNode = record.store.getAt(index);
    panel.treeNode = dataNode;
    var nodeType = dataNode.data.type.toUpperCase();
    if (dataNode.isRoot()) {
      me.showSelectTablesForm(panel);
    }

    if (nodeType) {
      switch (nodeType) {
        case 'DATAOBJECT':
        me.showDataObjectForm(panel);
        break;
        case 'KEYS':
        me.showSelectKeyFieldsForm(panel);
        break;
        case 'KEYPROPERTY':
        me.showDataKeyForm(panel);
        break;
        case 'PROPERTIES':
        me.showSelectPropertiesForm(panel);
        break;
        case 'DATAPROPERTY':
        me.showDataPropertyForm(panel);
        break;
        case 'RELATIONSHIPS':
        me.showRelationsForm(panel);
        break;
        case 'RELATIONSHIP':
        me.showSetRelationForm(panel);
        break;
      }
    }


  },

  onConnectToDatabase: function(button, e, eOpts) {
    var me = this;
    var form = button.up('connectionstringform');
    var panel = form.up('nhibernatepanel');
    var dataTree = panel.down('nhibernatetree');
    var dirNode = me.getDirNode(dataTree.dirNode);
    var context = dirNode.parentNode.data.text;//dirNode.data.record.ContextName;
    var endpoint = dirNode.data.record.Name;//dirNode.data.record.Endpoint;
    var baseUrl = dirNode.data.record.BaseUrl;
    var content = me.getMainContent();
    var dbProvider = form.getForm().findField('dbProvider').getValue().toUpperCase();
    var dbName = form.getForm().findField('dbName');
    var portNumber = form.getForm().findField('portNumber');
    var host = form.getForm().findField('host');
    var dbServer = form.getForm().findField('dbServer');
    var dbInstance = form.getForm().findField('dbInstance');
    var serviceNamePane = form.items.items[10];
    var dbSchema = form.getForm().findField('dbSchema');
    var servieName = '';
    var serName = '';
    dbPro  = dbProvider;
    dbSch = dbSchema.getValue();
    //dirNode.data.record.dbDict.Provider = dbProvider;
    //dirNode.data.record.dbDict.SchemaName = dbSchema.getValue();

    if (dbProvider.indexOf('ORACLE') > -1) {
      dbServer.setValue(host.getValue());
      dbName.setValue(dbSchema.getValue());
      servieName = serviceNamePane.items.items[0].value;
      serName = serviceNamePane.items.items[0].serName;
      dbInstance.setValue(servieName);
    }
    else if (dbProvider.indexOf('MSSQL') > -1) {
      host.setValue(dbServer.getValue());
      serviceName = dbInstance.getValue();
      dbSchema.setValue(dbSchema.getValue());
      //dbPro.setValue(dbProvider);
    }
    else if (dbProvider.indexOf('MYSQL') > -1) {
      dbName.setValue(dbSchema.getValue());
      dbInstance.setValue(dbSchema.getValue());
    }

    form.getForm().submit({
      url: 'AdapterManager/TableNames',//'nhibernate/TableNames',
      method: 'POST',
      timeout: 600000,
      params: {
        scope: context,
        app: endpoint,
        serName: serName,
        baseUrl: baseUrl
      },
      success: function (f, a) {
        dirNode.data.record.dbInfo = form.getForm().getValues();
        var dbInfo = dirNode.data.record.dbInfo;

        dbInfo.dbTableNames = Ext.JSON.decode(a.response.responseText);
        panel.dirNode = dirNode;

        me.showSelectTablesForm(panel);
        return;

      },
      failure: function (f, a) {
        if (a.response)
        showDialog(500, 400, 'Error', a.response.responseText, Ext.Msg.OK, null);
        else {
          showDialog(400, 100, 'Warning', 'Please fill in every field in this form.', Ext.Msg.OK, null);
        }
      }//,
      // waitMsg: 'Loading ...'
    });
  },

  onSaveDataObjects: function(button, e, eOpts) {

    var me = this;
    var content = this.getMainContent();
    var panel = button.up('nhibernatepanel');
    var dbObjectsTree = panel.down('nhibernatetree');
    var dirNode = me.getDirNode(dbObjectsTree.dirNode);
    var rootNode = dbObjectsTree.getRootNode();
    var form = panel.down('selecttablesform');
    //var objectGrid = form.down('multiselectcomponentgrid').items.items[2];//form.down('multiselectiongrid');
    //var boundlist = objectGrid.items.items[0].items.items[2].items.items[0].items.items[0];
    var selected = form.down('multiselectcomponentgrid').items.items[2].items.items[0].items.items[2].store.data.items;//objectGrid.getSelections(boundlist);//objectGrid.getSelectionModel().getSelection();

    var serName = '';
    var dbInfo = dirNode.data.record.dbInfo;
    var dbDict = dirNode.data.record.dbDict;

    var context = dirNode.parentNode.data.text;
    var datalayer = dirNode.data.record.DataLayer;
    var endpoint = dirNode.data.record.Name;
    var baseUrl = dirNode.data.record.BaseUrl;

    if( dbDict.Provider == null)
    dbDict.Provider = dbPro;
    if( dbDict.SchemaName == null)
    dbDict.SchemaName = dbSch;

    dbInfo.dbSchema = dbDict.SchemaName;
    dbDict.enableSummary = form.getForm().findField('enableSummary').value;
    if (dbObjectsTree.disabled) {
      dbObjectsTree.enable();
    }

    if (dbInfo.serName)
    serName = dbInfo.serName;
    var flag = true;
    if (selected.length < 1) {
      while (rootNode.firstChild) {
        rootNode.removeChild(rootNode.firstChild);
        flag = false;
      }
      if(flag)
      showDialog(200, 100, 'Warning', 'No tables selected....', Ext.Msg.OK, null);
      return;
    } else {

      userTableNames = [];
      Ext.each(selected, function (table) {
        userTableNames.push(table.data.text);
      });
    }
    dbObjectsTree.selectedTables = userTableNames;

    var treeStore = dbObjectsTree.getStore();
    treeStore.on('beforeload', function (store, operation) {
      var params = store.proxy.extraParams;
      params.dbProvider = dirNode.data.record.dbDict.Provider;//dbPro;//dbDict.Provider;
      params.dbServer = dbInfo.dbServer;
      params.dbInstance = dbInfo.dbInstance;
      params.dbName = dbInfo.dbName;
      params.dbSchema = dirNode.data.record.dbDict.SchemaName;//dbSch;//dbInfo.dbSchema;
      params.dbPassword = dbInfo.dbPassword;
      params.dbUserName = dbInfo.dbUserName;
      params.portNumber = dbInfo.portNumber;
      params.tableNames = userTableNames;
      params.serName = serName;
      params.scope = dirNode.parentNode.data.text;//dirNode.data.record.ContextName;
      params.app = dirNode.data.record.Name;//dirNode.data.record.Endpoint;
      params.baseUrl = dirNode.data.record.BaseUrl;
    }, me);

    panel.body.mask('Loading...', 'x-mask-loading');
    //treeStore.load();
    treeStore.load({
      callback: function (records, options, success) {
        var rootNode = treeStore.getRootNode();
        me.reloadTree(rootNode, dbDict);

      }
    });
    me.getTableNames(context, endpoint, baseUrl, dirNode);
    panel.body.unmask();
  },

  onResetDataObjects: function(button, e, eOpts) {
    var me = this;
    var form = button.up('selecttablesform');
    var grid = form.down('multiselectiongrid');

    var panel = form.up('nhibernatepanel');
    var dataTree = panel.down('nhibernatetree');
    var dirNode = me.getDirNode(dataTree.dirNode);
    var dbInfo = dirNode.data.record.dbInfo;
    var dbDict = dirNode.data.record.dbDict;
    var rootNode = dataTree.getRootNode();
    var selectTableNamesSingle = [];
    var availTableName = [];
    var found = false;
    var repeatItem;
    for (var i = 0; i < dbInfo.dbTableNames.items.length; i++) {
      repeatItem = dbInfo.dbTableNames.items[i];
      availTableName.push([repeatItem, repeatItem]);
    }

    for (var j = 0; j < availTableName.length; j++)
    for (var i = 0; i < rootNode.childNodes.length; i++) {
      //if (rootNode.childNodes[i].data.property.tableName.toLowerCase() == availTableName[j][0].toLowerCase()) {
      if (rootNode.childNodes[i].raw.properties.objectName.toLowerCase() == availTableName[j][0].toLowerCase()) {
        found = true;
        availTableName.splice(j, 1);
        j--;
        break;
      }
    }

    for (var i = 0; i < rootNode.childNodes.length; i++) {
      var nodeText = rootNode.childNodes[i].raw.properties.objectName;//rootNode.childNodes[i].data.property.tableName;
      selectTableNamesSingle.push(nodeText);
    }
    var itemSelecter = form.down('#multiselectcomponentgrid');
    itemSelecter.items.items[2].bindStore(grid.getStore());

    if(selectTableNamesSingle){
      var records = [];
      for(var jj=0;jj<selectTableNamesSingle.length;jj++){
        for(var  kk = 0;kk<grid.getStore().data.length;kk++){
          if(selectTableNamesSingle[jj] == grid.getStore().data.items[kk].data.text){
            records.push(grid.getStore().data.items[kk]);
            itemSelecter.items.items[2].items.items[0].items.items[0].getStore().remove(grid.getStore().data.items[kk]);
            break;
          }
        }     
      }

      itemSelecter.items.items[2].items.items[0].items.items[2].getStore().add(records);
    }


    //grid.selectItems(selectTableNamesSingle);
  },

  onFormCreaterelation: function(form, grid, relationName, eventOptions) {
    var me = this;
    var panel = form.up('nhibernatepanel');
    me.showSetRelationForm(panel);
  },

  onResetSelectPropertiesForm: function(button, e, eOpts) {

    var me = this;
    var form = button.up('selectpropertiesform');
    var grid = form.down('multiselectiongrid');

    var panel = form.up('nhibernatepanel');
    var dataTree = panel.down('nhibernatetree');
    var dirNode = me.getDirNode(dataTree.dirNode);
    var rootNode = dataTree.getRootNode();
    var dataNode = dataTree.getSelectedNode();
    var selectKeys = [];
    var availTableName = [];
    var found = false;
    var repeatItem;

    for (var i = 0; i < dataNode.childNodes.length; i++) {
      var keyText = dataNode.childNodes[i].data.text;
      selectKeys.push(keyText);
    }

    var itemSelecter = form.down('#multiselectcomponentgrid');
    //itemSelecter.items.items[2].bindStore(grid.getStore());
    itemSelecter.items.items[2].items.items[0].items.items[2].bindStore(grid.getStore());
    if(selectKeys){
      var records = [];
      var flag;
      for(var jj=0;jj<dataNode.data.children.length;jj++){
        flag = true;
        for(var  kk = 0;kk< selectKeys.length;kk++){
          if(selectKeys[kk] == dataNode.data.children[jj].text){
            flag = false; 
            //records.push(grid.getStore().data.items[kk]);
            //itemSelecter.items.items[2].items.items[0].items.items[0].getStore().remove(grid.getStore().data.items[kk]);
            break;
          }
        }
        if(flag)
        records.push(dataNode.data.children[jj]);

      }
      itemSelecter.items.items[2].items.items[0].items.items[0].getStore().removeAll();
      itemSelecter.items.items[2].items.items[0].items.items[0].getStore().add(records);
      itemSelecter.items.items[2].items.items[0].items.items[2].getStore().removeAll();
      itemSelecter.items.items[2].items.items[0].items.items[2].getStore().add(dataNode.childNodes);
      //itemSelecter.items.items[2].getStore().add(records);
    }


    //grid.selectItems(selectTableNamesSingle);
  },

  onResetConnectionForm: function(button, e, eOpts) {

    var me = this;
    var form = button.up('connectionstringform');
    var panel = form.up('nhibernatepanel');
    var tree = panel.down('nhibernatetree');
    var dirNode = me.getDirNode(tree.dirNode);
    var dbInfo = dirNode.data.record.dbInfo;
    var dbDict = dirNode.data.record.dbDict;

    if(dbInfo && dbDict){
      form.getForm().findField('dbProvider').setValue(dbDict.Provider);
      form.getForm().findField('dbServer').setValue(dbInfo.dbServer);
      form.getForm().findField('dbInstance').setValue(dbInfo.dbInstance);
      form.getForm().findField('dbName').setValue(dbInfo.dbName);
      form.getForm().findField('dbUserName').setValue(dbInfo.dbUserName);
      form.getForm().findField('dbPassword').setValue(dbInfo.dbPassword);
      form.getForm().findField('dbSchema').setValue(dbDict.SchemaName);
    }

  },

  onConfignhibernate: function() {

    var me = this;
    var dirTree = me.getDirTree();
    dirNode = dirTree.getSelectedNode();
    content = me.getMainContent();
    //utilsObj.abc = [];
    //utilsObj.relationGridDeletedRec =[];
    var dbDict, dbInfo, tree;

    var context = dirNode.parentNode.data.text;//dirNode.data.record.ContextName;
    var datalayer = dirNode.data.record.DataLayer;
    var endpoint = dirNode.data.record.Name;//dirNode.data.record.Endpoint;
    var baseUrl = dirNode.data.record.BaseUrl;
    var title = 'Nhibernate Configuration - ' + context + '.' + endpoint;

    var panel = content.down('nhibernatepanel[title='+title+']');

    if(!panel) {
      panel = Ext.widget('nhibernatepanel', {
        'title': title
      });  
      //content.add(panel);

      tree = panel.down('nhibernatetree');

      tree.dirNode = dirNode.internalId;
      var treeStore = tree.getStore();
      var treeProxy = treeStore.getProxy();

      dbDict = me.getDbDictionary(context, endpoint, baseUrl, function(dbDict) { 
        if(dbDict.ConnectionString !== null && dbDict.ConnectionString !=undefined ) {
          var base64 = AM.view.nhibernate.Utility;
          dbDict.ConnectionString = base64.decode(dbDict.ConnectionString);
          if(dbDict) {
            var cstr = dbDict.ConnectionString;
            if(cstr) {
              dirNode.data.record.dbDict = dbDict;
              dbInfo = me.getConnStringParts(cstr, dirNode);
              var selectTableNames = me.setTableNames(dbDict);

              treeStore.on('beforeload', function (store, action) {
                var params = treeProxy.extraParams;
                params.dbProvider = dbDict.Provider;
                params.dbServer = dbInfo.dbServer;
                params.dbInstance = dbInfo.dbInstance;
                params.dbName = dbInfo.dbName;
                params.dbSchema = dbDict.SchemaName;
                params.dbPassword = dbInfo.dbPassword;
                params.dbUserName = dbInfo.dbUserName;
                params.portNumber = dbInfo.portNumber;
                params.tableNames = selectTableNames;
                params.serName = dbInfo.serName;
                params.scope = context;
                params.app = endpoint;
                params.baseUrl = baseUrl;
              }, me);


              /* treeStore.on('afterload', function (treeLoader, node) { 
              var rootNode = treeStore.getRootNode();
              me.reloadTree(rootNode, dbDict);
              }, me);*/

              //treeStore.load();
              treeStore.load({
                callback: function (records, options, success) {
                  var rootNode = treeStore.getRootNode();
                  me.reloadTree(rootNode, dbDict);

                }
              });

              me.getTableNames(context, endpoint, baseUrl, dirNode);
            }
          }
        } else {
          if (dbInfo !== null && dbInfo !== undefined)
          dirNode.data.record.dbInfo = dbInfo;

          if (dbDict !== null && dbDict !== undefined)
          dirNode.data.record.dbDict = dbDict;
          me.showConnectionStringForm(panel);
          var rootNode = tree.items.items[0].node;
          if(rootNode.isExpanded())
          rootNode.collapse();
          tree.disable();

        }
      });
      content.add(panel);
      //var myTab = content.add(panel);
      //content.setActiveTab(myTab);
    }
    me.getDataTypes();
    content.setActiveTab(panel);
  },

  init: function(application) {
    var me = this;
    me.application.addEvents('confignhibernate');

    this.control({
      "nhibernatepanel button[action=savedbobjectstree]": {
        click: this.onSaveDbObjectTree
      },
      "dataobjectform button[action=dataobjectformapply]": {
        click: this.onSaveDataObject
      },
      "dataobjectform button[action=dataobjectformreset]": {
        click: this.onResetDataObject
      },
      "selectdatakeysform button[action=saveselectkeys]": {
        click: this.onSaveKeyProperties
      },
      "selectpropertiesform button[action=saveselectproperties]": {
        click: this.onSaveDataProperties
      },
      "nhibernatetree button[action=editdbconnection]": {
        click: this.onEditDbConnection
      },
      "selectdatakeysform button[action=resetselectkeys]": {
        click: this.onResetKeyProperties
      },
      "button[action=savekeyfield]": {
        click: this.onSaveKeyProperty
      },
      "datakeyform button[action=resetkeyproperty]": {
        click: this.onResetKeyProperty
      },
      "setpropertyform button[action=savedataproperty]": {
        click: this.onSaveDataProperty
      },
      "setpropertyform button[action=resetdataproperty]": {
        click: this.onResetDataProperty
      },
      "nhibernatetree": {
        itemclick: this.onTreepanelItemClick
      },
      "button[action=connecttodatabase]": {
        click: this.onConnectToDatabase
      },
      "button[action=applyobjects]": {
        click: this.onSaveDataObjects
      },
      "selecttablesform button[action=resetobjects]": {
        click: this.onResetDataObjects
      },
      "form": {
        createrelation: this.onFormCreaterelation
      },
      "selectpropertiesform button[action=resetselectproperties] ": {
        click: this.onResetSelectPropertiesForm
      },
      " button[action=resetconnectionform]": {
        click: this.onResetConnectionForm
      }
    });

    application.on({
      confignhibernate: {
        fn: this.onConfignhibernate,
        scope: this
      }
    });
  },

  hasShown: function(shownArray, text) {
    for (var shownIndex = 0; shownIndex < shownArray.length; shownIndex++)
    if (shownArray[shownIndex] == text)
    return true;
    return false;
  },

  getDbDictionary: function(context, endpoint, baseUrl, successCallback) {
    var me = this;
    var dbDict, dbInfo;
    Ext.Ajax.request({
      url: 'AdapterManager/DBDictionary',//'NHibernate/DBDictionary',
      method: 'POST',
      timeout: 6000000,
      params: {
        scope: context,
        app: endpoint,
        baseUrl: baseUrl
      },
      success: function (response, request) {
        dbDict = Ext.JSON.decode(response.responseText);
        successCallback(dbDict);
      },
      failure: function (response, request) {
        //var dataObjPanel = content.items.map[contextName + '.' + endpoint + '.-nh-config'];;
      }
    });
  },

  getTableNames: function(context, endpoint, baseUrl, dirNode) {
    var me = this;
    var dbInfo = dirNode.data.record.dbInfo;
    var dbDict = dirNode.data.record.dbDict;

    Ext.Ajax.request({
      url: 'AdapterManager/TableNames',
      method: 'POST',
      timeout: 6000000,
      params: {
        scope: context,
        app: endpoint,
        dbProvider: dbDict.Provider,
        dbServer: dbInfo.dbServer,
        dbInstance: dbInfo.dbInstance,
        dbName: dbInfo.dbName,
        dbSchema: dbDict.SchemaName,
        dbUserName: dbInfo.dbUserName,
        dbPassword: dbInfo.dbPassword,
        portNumber: dbInfo.portNumber,
        serName: dbInfo.serName,
        baseUrl: baseUrl
      },
      success: function (response, request) {
        dirNode.data.record.dbInfo.dbTableNames = Ext.JSON.decode(response.responseText);
      },
      failure: function (f, a) {
        if (a.response)
        showDialog(500, 400, 'Error', a.response.responseText, Ext.Msg.OK, null);
      }
    });
  },

  setTableNames: function(dbDict) {
    var selectTableNames = [];

    for (var i = 0; i < dbDict.dataObjects.length; i++) {
      var tableName = (dbDict.dataObjects[i].tableName ? dbDict.dataObjects[i].tableName : dbDict.dataObjects[i]);
      selectTableNames.push(tableName);
    }
    return selectTableNames;
  },

  getAvailableItems: function(node) {
    var availItems = [];
    var propertiesNode = node.parentNode.childNodes[1];

    for (var i = 0; i < propertiesNode.childNodes.length; i++) {
      var itemName = propertiesNode.childNodes[i].data.text;//propertiesNode.childNodes[i].text;
      var found = false;

      for (var j = 0; j < node.childNodes.length; j++) {
        if (node.childNodes[j].data.text.toLowerCase() == itemName.toLowerCase()) {//if (node.childNodes[j].text.toLowerCase() == itemName.toLowerCase()) {
          found = true;
          break;
        }
      }
      //if (!found) {
      availItems.push([itemName, itemName]);
      //}
    }
    return availItems;
  },

  getSelectedItems: function(node) {
    var selectedItems = [];
    var propertiesNode = node.parentNode.childNodes[1];

    for (var i = 0; i < node.childNodes.length; i++) {
      var keyName = node.childNodes[i].text;
      selectedItems.push([keyName, keyName]);
    }
    return selectedItems;

  },

  getSelectItems: function(node) {
    var selectItems = [];

    for (var i = 0; i < node.childNodes.length; i++) {
      var keyName = node.childNodes[i].data.text;
      selectItems.push(keyName);
    }

    return selectItems;
  },

  showSelectTablesForm: function(nhibernatePanel) {
    var me = this, 
    form = me.getSelectTablesForm();
    var dataTree = nhibernatePanel.down('nhibernatetree');
    var dirNode = me.getDirNode(dataTree.dirNode);
    var selected = [];
    var dict = dataTree.getStore().tree.root.childNodes;//dirNode.data.record.dbDict.dataObjects;
    Ext.each(dict, function(table) {
      //selected.push(table.data.tableName);
      selected.push(table.data.text);
    });

    var tables = dirNode.data.record.dbInfo.dbTableNames.items; 
    var grid = form.down('#tablesSelectionGrid');
    var itemSelecter = form.down('#multiselectcomponentgrid');

    //var tempStore = itemSelecter.items.items[0].getStore();
    grid.loadItems(tables);
    //var updatedStore = grid.getStore();
    for(var i=0;i<tables.length;i++){
      grid.getStore().data.items[i].data.text = tables[i];
      grid.getStore().data.items[i].data.value = tables[i];
    }

    itemSelecter.items.items[2].bindStore(grid.getStore());
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(0);
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(0);
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(3);
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(3);
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(2);
    //grid.down('gridcolumn').setText('Select Data Tables');
    grid.selectItems(selected);
    //itemSelecter.items.items[1].selectItems(selected);
    //var tempStore = itemSelecter.items.items[2].getStore();
    if(selected){

      var records = [];
      utilsObj.deletedTables = [];
      Ext.each(selected, function(item) {
        var record = grid.getStore().findRecord('text', item);
        if(record) {
          records.push(record); 
          utilsObj.deletedTables.push(record);
          itemSelecter.items.items[2].items.items[0].items.items[0].getStore().remove(record);
        } 
        //tempStore.remove(record);
      });
      itemSelecter.items.items[2].items.items[0].items.items[2].getStore().add(utilsObj.deletedTables);
      //itemSelecter.items.items[2].bindStore(tempStore);
    }

    panel = nhibernatePanel.down('#nhibernateContent');

    panel.removeAll();
    panel.doLayout();

    panel.add(form);
    panel.doLayout();


  },

  showConnectionStringForm: function(nhibernatePanel) {
    var me = this,

      form = me.getConnectionStringForm();
    var dataTree = nhibernatePanel.down('nhibernatetree');

    var dirNode = me.getDirNode(dataTree.dirNode);

    var dbDict = dirNode.data.record.dbDict;
    var combo = form.down('#providerCombo');
    combo.on('select', function (combo, record, options) {
      var dbProvider = record[0].data.Provider.toUpperCase();
      var dbName = form.getForm().findField('dbName');
      var portNumber = form.getForm().findField('portNumber');
      var host = form.getForm().findField('host');
      var dbServer = form.getForm().findField('dbServer');
      var dbInstance = form.getForm().findField('dbInstance');
      var serviceName = form.down('#oraclecontainer');
      var dbSchema = form.getForm().findField('dbSchema');
      var userName = form.getForm().findField('dbUserName');
      var password = form.getForm().findField('dbPassword');
      var sid = form.getForm().findField('field_sid');
      var serName = form.getForm().findField('field_serviceName');

      if (dbProvider.indexOf('ORACLE') > -1) {
        if (dbName.hidden === false) {
          dbName.hide();
          dbServer.hide();
          dbInstance.hide();
        }

        if (host.hidden === true) {
          if (dbDict.Provider) {
            if (dbDict.Provider.toUpperCase().indexOf('ORACLE') > -1) {
              host.setValue(dbInfo.dbServer);
              sid.setValue(dbInfo.dbInstance);
              serName.setValue(dbInfo.serName);
              serviceName.show();
              host.show();
              userName.setValue(dbInfo.dbUserName);
              password.setValue(dbInfo.dbPassword);
              dbSchema.setValue(dbDict.SchemaName);
            }
            else
            me.resetConfigOracle(host, dbSchema, userName, password, serviceName, sid, serName);
          }
          else
          me.resetConfigOracle(host, dbSchema, userName, password, serviceName, sid, serName);

          portNumber.setValue('1521');
          portNumber.show();
        }
      }
      else if (dbProvider.indexOf('MSSQL') > -1) {
        if (host.hidden === false) {
          portNumber.hide();
          host.hide();
          sid.clearInvalid();
          sid.disable();
          serName.clearInvalid();
          serName.disable();
          serviceName.hide();
        }

        if (dbName.hidden === true) {
          if (dbDict.Provider) {
            if (dbDict.Provider.toUpperCase().indexOf('MSSQL') > -1) {
              dbName.setValue(dbInfo.dbName);
              dbServer.setValue(dbInfo.dbServer);
              dbInstance.setValue(dbInfo.dbInstance);
              dbName.show();
              dbServer.show();
              dbInstance.show();
              sid.clearInvalid();
              sid.disable();
              serName.clearInvalid();
              serName.disable();
              dbSchema.setValue(dbDict.SchemaName);
              userName.setValue(dbInfo.dbUserName);
              password.setValue(dbInfo.dbPassword);
            }
            else
            me.resetConfigMsSql(dbName, dbServer, dbInstance, dbSchema, userName, password);
          }
          else
          me.resetConfigMsSql(dbName, dbServer, dbInstance, dbSchema, userName, password);
        }

        portNumber.setValue('1433');
      }
      else if (dbProvider.indexOf('MYSQL') > -1) {
        if (dbServer.hidden === true) {
          dbServer.setValue('');
          dbServer.clearInvalid();
          dbServer.show();
        }

        if (host.hidden === false) {
          portNumber.hide();
          host.hide();
          sid.clearInvalid();
          sid.disable();
          serName.clearInvalid();
          serName.disable();
          serviceName.hide();
          portNumber.setValue('3306');
        }

      }

    }, me);

    var cmbStore = combo.getStore();
    var cmbProxy = cmbStore.getProxy();
    cmbStore.on('beforeload', function(store, action) {
      cmbProxy.extraParams.baseUrl = node.data.record.BaseUrl;
    });
    cmbStore.load();
    //if(dirNode.data.record.dbInfo!=undefined)
    //dirNode.data.record.dbInfo.dbSchema = form.getForm().findField('dbSchema').getValue();
    form.setActive(dirNode.data.record.dbInfo);

    panel = nhibernatePanel.down('#nhibernateContent');
    panel.removeAll();
    panel.doLayout();
    panel.add(form);
  },

  showDataObjectForm: function(nhibernatePanel) {
    var me = this, 
    form = me.getDataObjectForm();
    var keyDelimeter;
    var description
    var dataTree = nhibernatePanel.down('nhibernatetree');
    var treeNode = dataTree.getSelectedNode();
    description = treeNode.raw.properties.description ;
    keyDelimeter = treeNode.raw.properties.keyDelimeter;
    //var tree = panel.down('nhibernatetree');
    //var treeNode = tree.getSelectedNode();
    var dirNode = me.getDirNode(dataTree.dirNode);
    /*if (!treeNode.data.property || treeNode.data.property.keyDelimiter === 'null' || 
    !treeNode.data.property.keyDelimiter || treeNode.data.property.keyDelimiter === undefined) {
    keyDelimiter = '_';
    }   else {
    keyDelimiter = treeNode.data.property.keyDelimiter;
    }

    form.getForm().findField('tableName').setValue(treeNode.data.property.tableName);
    form.getForm().findField('objectNamespace').setValue(treeNode.data.property.objectNamespace);
    form.getForm().findField('objectName').setValue(treeNode.data.property.objectName);
    form.getForm().findField('keyDelimiter').setValue(keyDelimiter);
    */
    var dbDict = dirNode.data.record.dbDict;
    for (var ijk = 0; ijk < dbDict.dataObjects.length; ijk++) {
      var dataObject = dbDict.dataObjects[ijk];
      if (treeNode.data.text.toUpperCase() != dataObject.objectName.toUpperCase())
      continue;
      description = dataObject.description;
      //description = treeNode.raw.properties.description;
      keyDelimeter = dataObject.keyDelimeter;
      //keyDelimeter = treeNode.raw.properties.keyDelimiter; 
    }
    /*if (treeNode.raw.properties.keyDelimiter === 'null' || 
    !treeNode.raw.properties.keyDelimiter || treeNode.raw.properties.keyDelimiter === undefined) {
    keyDelimiter = '_';
    }   else {
    keyDelimiter = treeNode.raw.properties.keyDelimiter;
    }*/
    if (keyDelimeter === 'null' ||!keyDelimeter || keyDelimeter === undefined) 
    keyDelimeter = '_';


    form.getForm().findField('tableName').setValue(treeNode.raw.text);
    form.getForm().findField('objectNamespace').setValue(treeNode.raw.properties.objectNamespace);
    form.getForm().findField('objectName').setValue(treeNode.raw.properties.objectName);
    form.getForm().findField('keyDelimeter').setValue(keyDelimeter);
    form.getForm().findField('description').setValue(description);

    panel = nhibernatePanel.down('#nhibernateContent');
    panel.removeAll();

    panel.add(form);
    panel.doLayout();
  },

  showRelationsForm: function(nhibernatePanel) {
    var me = this, 
    form = me.getRelationsForm();

    var grid = form.down('relationsgrid');

    var gridStore = grid.getStore();
    gridStore.removeAll();
    var dataTree = nhibernatePanel.down('nhibernatetree');
    var dirNode = me.getDirNode(dataTree.dirNode);
    var treeNode = dataTree.getSelectionModel().getSelection()[0];

    var context = dirNode.data.property.Context;
    var endpoint = dirNode.data.property.Name;

    grid.endpoint = form.endpoint = endpoint;
    grid.context = form.context = context;
    grid.node = form.node = treeNode;
    grid.rootNode = form.rootNode = dataTree.getRootNode();

    treeNode.eachChild(function(n) {
      gridStore.add({'relationName': n.data.text});
    });

    panel = nhibernatePanel.down('#nhibernateContent');

    panel.removeAll();

    panel.add(form);
    panel.doLayout();

    Ext.getBody().unmask();
  },

  showSetRelationForm: function(nhibernatepanel) {
    var me = this;
    var panel = nhibernatepanel.down('#nhibernateContent');
    var dataTree = nhibernatepanel.down('nhibernatetree');
    var dataNode = dataTree.getSelectedNode();
    var dirNode = me.getDirNode(dataTree.dirNode);
    var relationFolderNode, 
    contextName, 
    endpoint, 
    rootNode, 
    relationName;

    rootNode = dataTree.getRootNode();
    endpoint = dirNode.data.text;//dirNode.data.record.endpoint;
    contextName = dirNode.parentNode.data.text;//dirNode.data.record.context;

    if(dataNode.data.type =='relationships') {
      relationFolderNode = dataNode;
      if(dataNode.firstChild)
      relationName = dataNode.firstChild.data.text;
    } else {
      relationFolderNode = dataNode.parentNode;
      relationName = dataNode.data.text;
    }

    var dataObjectNode = relationFolderNode.parentNode;
    var relatedObjects = [];
    var thisObj = dataObjectNode.data.text;

    rootNode.eachChild(function(child) {
      if(child.data.text != thisObj) {
        relatedObjects.push([child.data.text, child.data.text,  child.data.text]); 
        // relatedObjects.push([child.data.text, child.data.text, child.data.property.tableName]);
      }
    });

    var relatedObjectName = relationFolderNode.childNodes[0].raw.relatedObjectName;
    var relatedObject;
    rootNode.eachChild(function(child) {
      if(child.data.text == relatedObjectName) {
        relatedObject = child; 
      }
    });
    var relatedObjectPropertyNodes = [];
    if(relatedObject!=undefined && relatedObject.childNodes[0]!=undefined && relatedObject.childNodes[1]!=undefined){
      relatedObject.childNodes[0].eachChild(function(child) {
        relatedObjectPropertyNodes.push([child.data.text, child.data.text, child.data.property.columnName]);
      });
      relatedObject.childNodes[1].eachChild(function(child) {
        relatedObjectPropertyNodes.push([child.data.text, child.data.text, child.data.property.columnName]);
      });

    }


    var keysNode = dataObjectNode.childNodes[0];
    var propertiesNode = dataObjectNode.childNodes[1];

    var propertyNodes = [];
    keysNode.eachChild(function(child) {
      propertyNodes.push([child.data.text, child.data.text, child.data.property.columnName]);
    });

    propertiesNode.eachChild(function(child) {
      propertyNodes.push([child.data.text, child.data.text, child.data.property.columnName]);
    });


    var form = me.getSetRelationForm();
    var grid = form.down('relationPropertyGrid');
    var gridStore;
    //if(utilsObj.relationGridStore!=undefined)
    // gridStore = utilsObj.relationGridStore;
    //else
    gridStore = grid.getStore();

    var propertyNameCmb = form.down('#propertyNameCmb');
    propertyNameCmb.store =  Ext.create('Ext.data.SimpleStore', {
      fields: ['value', 'text', 'name'],
      autoLoad: true,
      data: propertyNodes
    });

    propertyNameCmb.valueField = 'text';

    var relatedObjectCombo = form.down('#relatedObjectCmb');
    relatedObjectCombo.store = Ext.create('Ext.data.SimpleStore', {
      fields: ['value', 'text'],
      autoLoad: true,
      data: relatedObjects
    });

    relatedObjectCombo.valueField = 'value';

    var mapPropertyNameCmb = form.down('#mapPropertyNameCmb');
    mapPropertyNameCmb.store = Ext.create('Ext.data.SimpleStore', {
      fields: ['value', 'text', 'name'],
      autoLoad: true,
      data: relatedObjectPropertyNodes
    });
    mapPropertyNameCmb.valueField = 'text';

    form.endpoint = endpoint;
    form.contextName = contextName;
    form.rootNode = rootNode;
    form.node = relationFolderNode;

    relationFolderNode.eachChild(function(relation) {
      if(relation.data.text == relationName) {
        var data;
        if(relation.data.relationshipType)
        data = relation.data;
        else
        data = relation.raw;
        var pMap;
        if(data.propertyMap) {
          gridStore.removeAll();
          for(var i=0;i<data.propertyMap.length;i++){
            pMap = data.propertyMap[i];
            if(pMap){

              var record = [{
                'property':  pMap.dataPropertyName,
                'relatedProperty': pMap.relatedPropertyName
              }];
              var exist = gridStore.find('property', pMap.dataPropertyName);
              if(exist == -1)
              gridStore.add(record);

            }//else
            //gridStore.removeAll();
          }

          //var pMap = data.propertyMap[0];


        }else
        gridStore.removeAll();

        form.getForm().findField('relationType').setValue(data.relationshipType);
        form.getForm().findField('relatedObjectName').setValue(data.relatedObjectName);
      }
    });

    /*if(utilsObj.relationGridStore!=undefined){
    for(var i=0; i<utilsObj.relationGridStore.data.length;i++){
    var record = [{
    'property': utilsObj.relationGridStore.data.items[i].data.property,
    'relatedProperty': utilsObj.relationGridStore.data.items[i].data.relatedProperty
    }];
    var exist = gridStore.find('property', utilsObj.relationGridStore.data.items[i].data.property);
    if(exist == -1)
    gridStore.add(record);

    }
    }*/
    /*if(utilsObj.relationGridDeletedRec!=undefined){
    for(var j=0; j<utilsObj.relationGridDeletedRec.length;j++){
    var record = [{
    'property': utilsObj.relationGridDeletedRec[j].data.property,
    'relatedProperty': utilsObj.relationGridDeletedRec[j].data.relatedProperty
    }];
    var exist = gridStore.find('property', utilsObj.relationGridDeletedRec[j].data.property);
    if(exist != -1)
    gridStore.removeAt(exist);

    }
    }*/

    form.getForm().findField('relationshipName').setValue(relationName);
    form.getForm().findField('objectName').setValue(thisObj);
    if(utilsObj.parentNode!=null && utilsObj.parentNode!=dataNode.parentNode.parentNode.data.text){
      utilsObj.relationGridStore = [];
      utilsObj.parentNode = dataNode.parentNode.parentNode.data.text;
    }
    if(utilsObj.relationGridStore.length == 0){
      utilsObj.parentNode = dataNode.parentNode.parentNode.data.text;
      gridStore.each(function(record) {
        utilsObj.relationGridStore.push({'dataPropertyName': record.data.property, 'relatedPropertyName': record.data.relatedProperty});
      });
    }
    console.log(utilsObj.relationGridStore);
    panel.removeAll();
    panel.add(form);
    panel.doLayout();
  },

  getConnStringParts: function(connString, dirNode) {
    var me = this;
    var dsValue, serName;
    var connStrParts = connString.split(';');
    var dbDict = dirNode.data.record.dbDict;
    var provider = dbDict.Provider.toUpperCase();

    if (dirNode.data.record.dbInfo === undefined) {
      dirNode.data.record.dbInfo = {};
    }

    if (!dirNode.data.record.dbInfo.dbUserName)
    dirNode.data.record.dbInfo.dbName = dbDict.SchemaName;

    for (var i = 0; i < connStrParts.length; i++) {
      var pair = connStrParts[i].split('=');
      switch (pair[0].toUpperCase()) {
        case 'DATA SOURCE':
        if (provider.indexOf('MSSQL') > -1) {
          dsValue = pair[1].split('\\');
          dirNode.data.record.dbInfo.dbServer = (dsValue[0].toLowerCase() == '.' ? 'localhost' : dsValue[0]);
          dirNode.data.record.dbInfo.dbInstance = dsValue[1];
          dirNode.data.record.dbInfo.portNumber = 1433;
          dirNode.data.record.dbInfo.serName = '';
        }
        else if (provider.indexOf('MYSQL') > -1) {
          dirNode.data.record.dbInfo.dbServer = (pair[1].toLowerCase() == '.' ? 'localhost' : pair[1]);
          dirNode.data.record.dbInfo.portNumber = 3306;
        }
        else if (provider.indexOf('ORACLE') > -1) {
          var dsStr = connStrParts[i].substring(12, connStrParts[i].length);
          dsValue = dsStr.split('=');
          for (var j = 0; j < dsValue.length; j++) {
            dsValue[j] = dsValue[j].substring(dsValue[j].indexOf('(') + 1, dsValue[j].length);
            switch (dsValue[j].toUpperCase()) {
              case 'HOST':
              var server = dsValue[j + 1];
              var port = dsValue[j + 2];
              var index = server.indexOf(')');
              server = server.substring(0, index);
              dirNode.data.record.dbInfo.portNumber = port.substring(0, 4);
              dirNode.data.record.dbInfo.dbServer = (server.toLowerCase() == '.' ? 'localhost' : server);
              break;
              case 'SERVICE_NAME':
              serName = dsValue[j + 1];
              index = sername.indexOf(')');
              dirNode.data.record.dbInfo.dbInstance = serName.substring(0, index);
              dirNode.data.record.dbInfo.serName = 'SERVICE_NAME';
              break;
              case 'SID':
              serName = dsValue[j + 1];
              index = sername.indexOf(')');
              dirNode.data.record.dbInfo.dbInstance = serName.substring(0, index);
              dirNode.data.record.dbInfo.serName = 'SID';
              break;
            }
          }
        }
        break;
        case 'INITIAL CATALOG':
        dirNode.data.record.dbInfo.dbName = pair[1];
        break;
        case 'USER ID':
        dirNode.data.record.dbInfo.dbUserName = pair[1];
        break;
        case 'PASSWORD':
        dirNode.data.record.dbInfo.dbPassword = pair[1];
        break;
      }
    }
    return dirNode.data.record.dbInfo;
  },

  showSelectKeyFieldsForm: function(nhibernatePanel) {

    var me = this, 
    form = me.getSelectKeyFieldsForm();
    var selected = [];
    var dataTree = nhibernatePanel.down('nhibernatetree');
    var dataNode = dataTree.getSelectedNode();
    var dirNode = me.getDirNode(dataTree.dirNode);
    var context =dirNode.parentNode.data.text;//dirNode.data.record.context;
    var endpoint = dirNode.data.record.Name;//dirNode.data.record.endpoint;
    var baseUrl = dirNode.data.record.baseUrl;

    var grid = form.down('#multiSelectDataKeys');
    grid.down('gridcolumn').setText('Select Key Properties');
    var itemSelecter = form.down('#multiselectcomponentgrid');
    var availItems = [];
    var propertiesNode = dataNode.parentNode.childNodes[1];
    //var hiddenRootNode = propertiesNode.raw.hiddenNodes.hiddenNode;

    var selectItems = me.getSelectItems(dataNode);
    Ext.each(selectItems, function (item) {
      availItems.push(item);
    });

    /*Ext.each(hiddenRootNode.children, function(node) {
    availItems.push(node.text);
    });*/
    var availKeys = [];
    for (var i = 0; i < propertiesNode.data.children.length; i++) {
      var itemName = propertiesNode.data.children[i].text;//propertiesNode.childNodes[i].text;
      var found = false;

      for (var j = 0; j < propertiesNode.childNodes.length; j++) {
        if (propertiesNode.childNodes[j].data.text.toLowerCase() == itemName.toLowerCase()) {//if (node.childNodes[j].text.toLowerCase() == itemName.toLowerCase()) {
          found = true;
          break;
        }
      }
      if (!found) {
        if(selectItems.indexOf(itemName) == -1){
          availKeys.push([itemName, itemName]);
        }
      }
    }
    var availableItem = me.getAvailableItems(dataNode);
    /*for(l = 0;l<availKeys.length;l++){
    availableItem.push(availKeys[l]);
    }*/

    for(l = 0;l<availKeys.length;l++){
      var keyFlag = true;
      for(k = 0;k<availableItem.length;k++){
        if(availKeys[l][0] == selectItems[j])//availableItem[k][0])
        keyFlag = false;
      }
      if(keyFlag)
      availableItem.push(availKeys[l]);
    }
    Ext.each(availableItem, function(node) {
      availItems.push(node[0]);
    })
    grid.loadItems(availItems);
    //grid.selectItems(selectItems);
    for(var i=0;i<availItems.length;i++){
      grid.getStore().data.items[i].data.text = availItems[i];
      grid.getStore().data.items[i].data.value = availItems[i];
    }
    itemSelecter.items.items[2].bindStore(grid.getStore());
    itemSelecter.items.items[0].setText('Available Keys');
    itemSelecter.items.items[1].setText('Selected Keys');
    itemSelecter.items.items[1].margin = '0 0 0 153';
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(0);
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(0);
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(3);
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(3);
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(2);

    //itemSelecter.items.items[2].items.items[0].items.items[2].bindStore(grid.getStore());
    if(selectItems){
      utilsObj.deletedKeyProperties = [];
      var records = [];
      /*Ext.each(selectItems, function(item) {
      var record = grid.getStore().findRecord('text', item);
      if(record) {
      records.push(record);
      utilsObj.deletedKeyProperties.push(record);
      itemSelecter.items.items[2].items.items[0].items.items[0].getStore().remove(record);
      } 

      });*/
      for(var jj=0;jj<selectItems.length;jj++){
        for(var  kk = 0;kk<grid.getStore().data.length;kk++){
          if(selectItems[jj] == grid.getStore().data.items[kk].data.text){
            //records.push(record);
            utilsObj.deletedKeyProperties.push(grid.getStore().data.items[kk]);
            itemSelecter.items.items[2].items.items[0].items.items[0].getStore().remove(grid.getStore().data.items[kk]);
            break;
          }
        }     
      }

      itemSelecter.items.items[2].items.items[0].items.items[2].getStore().add(utilsObj.deletedKeyProperties);
    }

    panel = nhibernatePanel.down('#nhibernateContent');

    panel.removeAll();

    panel.add(form);
    panel.doLayout();

    Ext.getBody().unmask();


  },

  showSelectPropertiesForm: function(nhibernatePanel) {

    var me = this, 
    form = me.getSelectPropertiesForm();
    var selected = [];
    var dataTree = nhibernatePanel.down('nhibernatetree');
    var dataNode = dataTree.getSelectedNode();
    var dirNode = me.getDirNode(dataTree.dirNode);
    var context = dirNode.data.record.context;
    var endpoint = dirNode.data.record.endpoint;
    var baseUrl = dirNode.data.record.baseUrl;

    var grid = form.down('#propertiesSelectionGrid');
    grid.down('gridcolumn').setText('Select Data Properties');

    var availItems = [];
    var propertiesNode = dataNode.parentNode.childNodes[1];
    //var hiddenRootNode = propertiesNode.raw.hiddenNodes.hiddenNode;
    var availProperties = [];
    var selectItems = me.getSelectItems(dataNode);
    var availableItems = me.getAvailableItems(dataNode);//me.getAvailableItems(utilsObj.availableDataProperties);//
    Ext.each(selectItems, function (item) {
      availItems.push(item);
    });

    for (var i = 0; i < propertiesNode.data.children.length; i++) {
      var itemName = propertiesNode.data.children[i].text;//propertiesNode.childNodes[i].text;
      var found = false;

      for (var j = 0; j < propertiesNode.childNodes.length; j++) {
        if (propertiesNode.childNodes[j].data.text.toLowerCase() == itemName.toLowerCase()) {//if (node.childNodes[j].text.toLowerCase() == itemName.toLowerCase()) {
          found = true;
          break;
        }
      }
      if (!found) {
        var flag = true;
        for(var k = 0;k<propertiesNode.parentNode.childNodes[0].childNodes.length;k++){
          if(propertiesNode.parentNode.childNodes[0].childNodes[k].data.text == itemName)
          flag = false;
        }
        if(flag)
        availProperties.push([itemName, itemName]);
      }
    }

    /*
    Ext.each(hiddenRootNode.children, function(node) {
    availItems.push(node.text);
    });
    */

    /*Ext.each(availableItems, function(node) {
    availItems.push(node[0]);
    });*/

    grid.loadItems(availItems);
    //grid.selectItems(selectItems);
    var itemSelecter = form.down('#multiselectcomponentgrid');
    for(var i=0;i<availItems.length;i++){
      grid.getStore().data.items[i].data.text = availItems[i];
      grid.getStore().data.items[i].data.value = availItems[i];
    }
    /*var index;
    for(j=0;j<selectItems.length;j++){
    index = grid.store.find('text',selectItems[j]);
    utilsObj.deletedDataProperties = grid.store.getAt(index);
    grid.store.removeAt(index);
    }*/
    var blankStore = Ext.create('AM.store.MultiStore');
    blankStore.add(availProperties);
    itemSelecter.items.items[2].bindStore(blankStore);
    itemSelecter.items.items[2].items.items[0].items.items[2].bindStore(grid.getStore());
    itemSelecter.items.items[0].setText('Available Properties');
    itemSelecter.items.items[1].setText('Selected Properties');
    itemSelecter.items.items[1].margin = '0 0 0 120';


    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(0);
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(0);
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(3);
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(3);
    buttons = itemSelecter.items.items[2].items.items[0].items.items[1].items.removeAt(2);
    panel = nhibernatePanel.down('#nhibernateContent');

    panel.removeAll();

    panel.add(form);
    panel.doLayout();

    Ext.getBody().unmask();
  },

  showDataKeyForm: function(nhibernatePanel) {

    var me = this, 
    form = me.getDataKeyForm();

    var dataTree = nhibernatePanel.down('nhibernatetree');
    var dirNode = me.getDirNode(dataTree.dirNode);
    var treeNode = nhibernatePanel.treeNode;

    form.setActiveRecord(treeNode.data.property);

    panel = nhibernatePanel.down('#nhibernateContent');

    panel.removeAll();

    panel.add(form);
    panel.doLayout();

    Ext.getBody().unmask();
  },

  getDirNode: function(nodeInternalId) {
    var me = this;
    var dirTree = me.getDirTree();
    var treeStore = dirTree.getStore();
    return treeStore.getNodeById(nodeInternalId);
    //Returning slectd Node of dirTree

    /*var rootChilds = treeStore.tree.root.childNodes;
    if(rootChilds.length>0){
    for(var i=0;i<rootChilds.length;i++){
    if(rootChilds[i].data.text = 'RijTest'){
    var appChild = rootChilds[i];
    if(appChild.childNodes.length>0){
    for(var j=0;j<appChild.childNodes.length;j++){
    if(appChild.childNodes[j].data.text = 'RijTest222')
    return appChild.childNodes[j];
    }
    }
    }
    }
    }*/
  },

  showDataPropertyForm: function(nhibernatePanel) {

    var me = this, 
    form = me.getDataPropertyForm();

    var dataTree = nhibernatePanel.down('nhibernatetree');
    var dirNode = me.getDirNode(dataTree.dirNode);
    var treeNode = nhibernatePanel.treeNode;

    form.setActiveRecord(treeNode.data.property);

    panel = nhibernatePanel.down('#nhibernateContent');

    panel.removeAll();

    panel.add(form);
    panel.doLayout();

    Ext.getBody().unmask();
  },

  getJsonTree: function(rootNode, dirNode, selectedTables) {
    var me = this; 
    var treeProperty = {};
    treeProperty.dataObjects = [];
    treeProperty.IdentityConfiguration = null;
    var dbInfo = dirNode.data.record.dbInfo;
    var dbDict = dirNode.data.record.dbDict;
    var tProp = me.setTreeProperty(dbInfo, dbDict, selectedTables);
    treeProperty.connectionString = tProp.connectionString;
    if (treeProperty.connectionString !== null && treeProperty.connectionString.length > 0) {
      var base64 = AM.view.nhibernate.Utility;
      treeProperty.connectionString = base64.encode(tProp.connectionString);
    }
    treeProperty.schemaName = tProp.schemaName;
    treeProperty.provider = tProp.provider;
    treeProperty.enableSummary = tProp.enableSummary;

    var keyName;
    for (var i = 0; i < rootNode.childNodes.length; i++) {
      var folder = me.getFolderFromChildNode(rootNode.childNodes[i],dbDict.dataObjects[i]);
      treeProperty.dataObjects.push(folder);
    }

    /*for (var i = 0; i < dbDict.dataObjects.length; i++) {
    var folder = me.getFolderFromChildNode(dbDict.dataObjects[i]);
    treeProperty.dataObjects.push(folder);
    }*/

    dbDict.ConnectionString = treeProperty.connectionString;
    dbDict.SchemaName = treeProperty.schemaName;
    dbDict.Provider = treeProperty.provider;
    dbDict.dataObjects = treeProperty.dataObjects;
    dbDict.enableSummary = treeProperty.enableSummary;
    return treeProperty;
  },

  setTreeProperty: function(dbInfo, dbDict, selected) {
    var me = this;
    var treeProperty = {};
    if (selected) {
      treeProperty.enableSummary = dbDict.enableSummary;
      treeProperty.provider = dbDict.Provider;//dbPro;
    }  else if (dbDict.enableSummary)
    treeProperty.enableSummary = dbDict.enableSummary;
    else
    treeProperty.enableSummary = false;

    if (dbInfo) {
      var dbServer = dbInfo.dbServer;
      dbServer = (dbServer.toLowerCase() == 'localhost' ? '.' : dbServer);
      var upProvider = treeProperty.provider.toUpperCase();
      var serviceName = '';
      var serName = '';
      if (dbInfo.serName) {
        serviceName = serviceNamePane.items.items[0].value;
        serName = serviceNamePane.items.items[0].serName;
      }
      else if (dbInfo) {
        if (dbInfo.dbInstance)
        serviceName = dbInfo.dbInstance;
        if (dbInfo.serName)
        serName = dbInfo.serName;
      }

      if (upProvider.indexOf('MSSQL') > -1) {
        var dbInstance = dbInfo.dbInstance;
        var dbDatabase = dbInfo.dbName;
        if (dbInstance.toUpperCase() == "DEFAULT") {
          var dataSrc = 'Data Source=' + dbServer + ';Initial Catalog=' + dbDatabase;
        } else {
          var dataSrc = 'Data Source=' + dbServer + '\\' + dbInstance + ';Initial Catalog=' + dbDatabase;
        }
      }
      else if (upProvider.indexOf('ORACLE') > -1)
      var dataSrc = 'Data Source=' + 
      '(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=' + 
      dbServer + ')(PORT=' + dbInfo.portNumber + 
      ')))(CONNECT_DATA=(SERVER=DEDICATED)(' + serName + '=' + serviceName + ')))';
      else if (upProvider.indexOf('MYSQL') > -1)
      var dataSrc = 'Data Source=' + dbServer;
      treeProperty.connectionString = dataSrc + ';User ID=' + dbInfo.dbUserName + ';Password=' + dbInfo.dbPassword;
      treeProperty.schemaName = dbDict.SchemaName;
    }
    else {
      treeProperty.provider = dbDict.Provider;
      var dbServer = dbInfo.dbServer;
      var upProvider = treeProperty.provider.toUpperCase();
      dbServer = (dbServer.toLowerCase() == 'localhost' ? '.' : dbServer);

      if (upProvider.indexOf('MSSQL') > -1) {
        if (dbInfo.dbInstance) {
          if (dbInfo.dbInstance.toUpperCase() == "DEFAULT") {
            var dataSrc = 'Data Source=' + dbServer + ';Initial Catalog=' + dbInfo.dbName;
          } else {
            var dataSrc = 'Data Source=' + dbServer + '\\' + dbInfo.dbInstance + ';Initial Catalog=' + dbInfo.dbName;
          }
        }
      }
      else if (upProvider.indexOf('ORACLE') > -1)
      var dataSrc = 'Data Source=' + '(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=' + 
      dbServer + ')(PORT=' + dbInfo.portNumber + ')))(CONNECT_DATA=(SERVER=DEDICATED)(' + 
      dbInfo.serName + '=' + dbInfo.dbInstance + ')))';
      else if (upProvider.indexOf('MYSQL') > -1)
      var dataSrc = 'Data Source=' + dbServer;

      treeProperty.connectionString = dataSrc + ';User ID=' + dbInfo.dbUserName + ';Password=' + dbInfo.dbPassword;
      treeProperty.schemaName = dbDict.SchemaName;
    }
    return treeProperty;
  },

  getFolderFromChildNode: function(folderNode, dbDictNode) {
    var me = this;
    var folderNodeProp = folderNode.data.property;
    var folder = {};
    var keyName = '';
    if(dbDictNode){
      folder.tableName = dbDictNode.tableName;//folderNode.data.text;//folderNodeProp.tableName;
      folder.objectNamespace = dbDictNode.objectNamespace;//folderNode.raw.properties.objectNamespace;//folderNodeProp.objectNamespace;
      folder.objectName = dbDictNode.objectName;//folderNode.raw.properties.objectName;//folderNodeProp.objectName;
      folder.description = dbDictNode.description;//folderNode.raw.properties.description;//'';//folderNodeProp.description;
      if(dbDictNode.keyDelimeter && dbDictNode.keyDelimeter!= null)
      folder.keyDelimeter = dbDictNode.keyDelimeter;//folderNode.raw.properties.keyDelimeter;
      else
      folder.keyDelimeter = '_';
    }
    else{
      folder.tableName = folderNode.data.text;
      folder.objectNamespace = folderNode.raw.properties.objectNamespace;//folderNodeProp.objectNamespace;
      folder.objectName = folderNode.raw.properties.objectName;//folderNodeProp.objectName;
      folder.description = folderNode.raw.properties.description;//'';//folderNodeProp.description;

      if (folderNode.raw.properties.keyDelimeter && folderNode.raw.properties.keyDelimeter != 'null')
      folder.keyDelimeter = folderNode.raw.properties.keyDelimeter;
      //folderNode.raw.properties.keyDelimeter = folderNode.raw.properties.keyDelimeter;  
      else
      folder.keyDelimeter = '_';
    }





    folder.keyProperties = [];
    folder.dataProperties = [];
    folder.dataRelationships = [];

    folderNode.eachChild(function(child) {

    });

    for (var j = 0; j < folderNode.childNodes.length; j++) {
      if (folderNode.childNodes[1])
      var propertyFolderNode = folderNode.childNodes[1];    

      if (folderNode.childNodes[0])
      var keyFolderNode = folderNode.childNodes[0];   

      if (folderNode.childNodes[2])
      var relationFolderNode = folderNode.childNodes[2];   

      if (folderNode.childNodes[j])
      subFolderNodeText = folderNode.childNodes[j].data.text;

      switch (subFolderNodeText) {
        case 'Keys':
        if (keyFolderNode)
        var keyChildenNodes = keyFolderNode.childNodes;       

        for (var k = 0; k < keyChildenNodes.length; k++) {
          var keyNode = keyChildenNodes[k];          
          var keyProps = {};

          if (keyNode.data.property)
          var keyNodeProf = keyNode.data.property;         

          keyProps.keyPropertyName = keyNode.data.text;
          keyName = keyNode.data.text;
          folder.keyProperties.push(keyProps);
          var tagProps = {};
          tagProps.columnName = keyNodeProf.columnName;
          tagProps.propertyName = keyNode.data.text;

          if (typeof keyNodeProf.dataType == 'string')
          tagProps.dataType = me.getDataTypeIndex(keyNodeProf.dataType);
          else
          tagProps.dataType = keyNodeProf.dataType;

          tagProps.dataLength = keyNodeProf.dataLength;

          if (keyNodeProf.nullable)
          tagProps.isNullable = keyNodeProf.nullable.toString().toLowerCase();
          else
          tagProps.isNullable = 'false';

          tagProps.isHidden = 'false';

          if (!keyNodeProf.keyType)
          tagProps.keyType = 1;
          else
          if (typeof keyNodeProf.keyType != 'string')
          tagProps.keyType = keyNodeProf.keyType;
          else {
            switch (keyNodeProf.keyType.toLowerCase()) {
              case 'assigned':
              tagProps.keyType = 1;
              break;
              case 'unassigned':
              tagProps.keyType = 0;
              break;
              default:
              tagProps.keyType = 1;
              break;
            }
          }

          if (keyNodeProf.showOnIndex)
          tagProps.showOnIndex = keyNodeProf.showOnIndex.toString().toLowerCase();
          else
          tagProps.showOnIndex = 'false';

          tagProps.numberOfDecimals = keyNodeProf.numberOfDecimals;
          folder.dataProperties.push(tagProps);    
        }
        break;
        case 'Properties':
        if (folderNode.childNodes[1]) {
          var propChildenNodes = propertyFolderNode.childNodes;
          if(propChildenNodes.length > 0)
          folder = me.prepareProperties(folder, propChildenNodes, 'false', keyName);
        }
        break;
        case 'Relationships':
        if (!relationFolderNode)
        break;

        if (relationFolderNode.childNodes)
        var relChildenNodes = relationFolderNode.childNodes;       

        if (relChildenNodes)
        for (var k = 0; k < relChildenNodes.length; k++) {
          var relationNode = relChildenNodes[k];
          var found = false;
          for (var ik = 0; ik < folder.dataRelationships.length; ik++)
          if (relationNode.data.text.toLowerCase() == folder.dataRelationships[ik].relationshipName.toLowerCase()) {
            found = true;
            break;
          }

          if (found || relationNode.data.text === '')
          continue;

          //relationNodeAttr = relationNode.data;
          relationNodeAttr = relationNode.raw;
          var relation = {};
          relation.propertyMaps = [];
          var pMap;
          if(relationNode.data.propertyMap!=undefined)
          pMap = relationNode.data.propertyMap;
          else
          pMap = relationNodeAttr.propertyMap;
          for (var m = 0; m < pMap.length; m++) {
            var propertyPairNode = pMap[m];
            var propertyPair = {};

            propertyPair.dataPropertyName = propertyPairNode.dataPropertyName;
            propertyPair.relatedPropertyName = propertyPairNode.relatedPropertyName;
            relation.propertyMaps.push(propertyPair);
          }

          relation.relatedObjectName = relationNodeAttr.relatedObjectName;
          relation.relationshipName = relationNodeAttr.text;
          relation.relationshipType = relationNodeAttr.relationshipTypeIndex;
          folder.dataRelationships.push(relation);
        }
        break;
      }
    }
    return folder;
  },

  prepareProperties: function(folder, propChildNodes, ifHidden, keyName) {
    var me = this;
    var hasData = false;
    if(propChildNodes.length === 0) return folder;
    for (var k = 0; k < propChildNodes.length; k++) {
      var propertyNode = propChildNodes[k];

      if (propertyNode.data !== undefined) {
        if (propertyNode.data.property !== undefined) {
          var propertyNodeProf = propertyNode.data.property;
          hasData = true;
        }
      }

      if (!hasData)
      var propertyNodeProf = propertyNode.data.property;//propertyNode.raw.properties;

      var props = {};
      if(propertyNode.raw.properties == undefined && propertyNode.raw.property!=undefined)
      propertyNode.raw.properties = propertyNode.raw.property;

      props.columnName = propertyNodeProf.columnName;//propertyNode.raw.properties.columnName;
      props.propertyName = propertyNodeProf.propertyName;//propertyNode.raw.properties.propertyName;

      if (typeof propertyNode.raw.properties.dataType.toLowerCase() == 'string')
      props.dataType = me.getDataTypeIndex(propertyNode.raw.properties.dataType);
      else
      props.dataType = propertyNodeProf.dataType;

      props.dataLength = propertyNode.raw.properties.dataLength;

      if (propertyNode.raw.properties.nullable)
      props.isNullable =propertyNode.raw.properties.nullable.toString().toLowerCase();
      else
      props.isNullable = 'false';

      if (keyName !== '') {
        if (props.columnName == keyName)
        props.keyType = 1;
        else
        props.keyType = 0;
      }
      else
      props.keyType = 0;

      if (propertyNode.raw.properties.showOnIndex)
      props.showOnIndex = propertyNode.raw.properties.showOnIndex.toString().toLowerCase();
      else
      props.showOnIndex = 'false';

      props.isHidden = ifHidden;
      props.numberOfDecimals = propertyNode.raw.properties.numberOfDecimals;
      folder.dataProperties.push(props);
    }
    return folder;
  },

  getDataTypeIndex: function(dataType) {
    var me = this;
    if (me.dataTypes === undefined)
    return;

    var i = 0;

    while (me.dataTypes[i] === undefined)
    i++;

    for (var k = i; k < me.dataTypes.length; k++) {
      if (me.dataTypes[k][1] == dataType)
      return me.dataTypes[k][0];
    }
  },

  getDataTypes: function() {
    var me = this;
    Ext.Ajax.request({
      url: 'AdapterManager/DataType',
      method: 'GET',
      timeout: 6000000,
      success: function (response, request) {
        var dataTypeName = Ext.JSON.decode(response.responseText);
        me.dataTypes = [];
        var i = 0;
        while (!dataTypeName[i])
        i++;
        while (dataTypeName[i]) {
          me.dataTypes.push([i, dataTypeName[i]]);
          i++;
        }
      },
      failure: function (f, a) {
        if (a.response)
        showDialog(500, 400, 'Error', a.response.responseText, Ext.Msg.OK, null);
      }
    });
  },

  resetConfigOracle: function(host, dbSchema, userName, password, serviceName, sid, serName) {
    host.setValue('');
    host.clearInvalid();

    host.show();

    dbSchema.setValue('');
    dbSchema.clearInvalid();

    userName.setValue('');
    userName.clearInvalid();

    password.setValue('');
    password.clearInvalid();
    serviceName.show();

    sid.setValue('');
    sid.clearInvalid();

    sid.setValue('');
    sid.clearInvalid(); 
  },

  resetConfigMsSql: function(dbName, dbServer, dbInstance, dbSchema, userName, password) {
    dbName.setValue('');
    dbName.clearInvalid();
    dbName.show();

    dbServer.setValue('localhost');
    dbServer.show();

    dbInstance.setValue('default');
    dbInstance.show();

    dbSchema.setValue('dbo');

    userName.setValue('');
    userName.clearInvalid();

    password.setValue('');
    password.clearInvalid();
  },

  reloadTree: function(rootNode, dbDict) {
    //alert('This is reloadTree...');
    var me = this;
    var relationTypeStr = ['OneToOne', 'OneToMany'];

    // sync data object tree with data dictionary
    for (var i = 0; i < rootNode.childNodes.length; i++) {
      var dataObjectNode = rootNode.childNodes[i];

      //dataObjectNode.attributes.properties.tableName = dataObjectNode.text;
      for (var ijk = 0; ijk < dbDict.dataObjects.length; ijk++) {
        var dataObject = dbDict.dataObjects[ijk];		  

        if (dataObjectNode.data.text.toUpperCase() != dataObject.tableName.toUpperCase())
        continue;

        // sync data object
        //dataObjectNode.attributes.properties.objectNamespace = dataObject.objectNamespace;
        dataObjectNode.raw.properties.objectNamespace = dataObject.objectNamespace;
        //dataObjectNode.attributes.properties.objectName = dataObject.objectName;
        dataObjectNode.raw.properties.objectName = dataObject.objectName;
        //dataObjectNode.attributes.properties.keyDelimiter = dataObject.keyDelimeter;
        dataObjectNode.raw.properties.keyDelimiter = dataObject.keyDelimeter;

        //dataObjectNode.attributes.properties.description = dataObject.description;

        dataObjectNode.data.text = dataObject.objectName;
        //dataObjectNode.attributes.text = dataObject.objectName;
        //dataObjectNode.setText(dataObject.objectName);

        if (dataObject.objectName.toLowerCase() == dataObjectNode.data.text.toLowerCase()) {
          var shownProperty = new Array();	
          var keysNode = dataObjectNode.childNodes[0];//dataObjectNode.attributes.children[0];
          var propertiesNode = dataObjectNode.childNodes[1];//dataObjectNode.attributes.children[1];
          var relationshipsNode = dataObjectNode.childNodes[2];//dataObjectNode.attributes.children[2];
          utilsObj.availableDataProperties = propertiesNode.data.children;
          var selectedItems = [];
          var availableItems = [];
          var myFlag;
          // sync data properties
          for (var j = 0; j < propertiesNode.data.children.length; j++) {
            myFlag = true;
            for (var jj = 0; jj < dataObject.dataProperties.length; jj++) {
              if (propertiesNode.data.children[j].text.toLowerCase() == dataObject.dataProperties[jj].columnName.toLowerCase()) {

                /*if (!me.shown(shownProperty, propertiesNode.data.children[j].text.toLowerCase())) {
                shownProperty.push(propertiesNode.data.children[j].text.toLowerCase());
                propertiesNode.data.children[j].hidden = true;
                }*/
                propertiesNode.childNodes[j].data.text = dataObject.dataProperties[jj].propertyName;
                propertiesNode.childNodes[j].data.property.propertyName = dataObject.dataProperties[jj].propertyName;
                propertiesNode.childNodes[j].data.property.isHidden = dataObject.dataProperties[jj].isHidden;

                propertiesNode.data.children[j].text = dataObject.dataProperties[jj].propertyName;
                propertiesNode.data.children[j].properties.propertyName = dataObject.dataProperties[jj].propertyName;
                propertiesNode.data.children[j].properties.isHidden = dataObject.dataProperties[jj].isHidden;
                selectedItems.push(propertiesNode.data.children[j]);
                myFlag = false;
              }
            }
            if(myFlag){
              availableItems.push(propertiesNode.data.children[j]);
              //propertiesNode.data.children.splice(j, 1);
              //propertiesNode.removeChild(propertiesNode.data.children[j], false);
            }
          }
          //propertiesNode.removeAll();
          /*for(p = 0;p<dataObject.keyProperties.length;p++){
          for(q = 0;q<selectedItems.length;q++){
          if(dataObject.keyProperties[p].keyPropertyName == selectedItems[q].text)
          selectedItems.splice(selectedItems[q],1);
          break;
          }
          }*/
          for(m =0;m<availableItems.length;m++){
            for(n = 0;n<propertiesNode.childNodes.length;n++){
              if(propertiesNode.childNodes[n].data.text == availableItems[m].text)
              propertiesNode.removeChild(propertiesNode.childNodes[n]);
            }
          }
          for(jj =0;jj<dataObject.keyProperties.length;jj++){
            for(kk = 0;kk<propertiesNode.childNodes.length;kk++){
              if(propertiesNode.childNodes[kk].data.text == dataObject.keyProperties[jj].keyPropertyName)
              propertiesNode.removeChild(propertiesNode.childNodes[kk]);
            }
          }

          // sync key properties
          for (var ij = 0; ij < dataObject.keyProperties.length; ij++) {
            for (var k = 0; k < keysNode.data.children.length; k++) {
              for (var ikk = 0; ikk < dataObject.dataProperties.length; ikk++) {
                if (dataObject.keyProperties[ij].keyPropertyName.toLowerCase() == dataObject.dataProperties[ikk].propertyName.toLowerCase()) {
                  if (keysNode.data.children[k].text.toLowerCase() == dataObject.dataProperties[ikk].columnName.toLowerCase()) {
                    keysNode.data.children[k].text = dataObject.keyProperties[ij].keyPropertyName;
                    //keysNode.data.children[k].properties.propertyName = dataObject.keyProperties[ij].keyPropertyName;
                    keysNode.data.children[k].property.propertyName = dataObject.keyProperties[ij].keyPropertyName; 
                    keysNode.data.children[k].property.isHidden = dataObject.keyProperties[ij].isHidden;
                    ij++;
                    break;
                  }
                }
              }
              break;
            }
            if (ij < dataObject.keyProperties.length) {
              for (var ijj = 0; ijj < propertiesNode.data.children.length; ijj++) {
                var nodeText = dataObject.keyProperties[ij].keyPropertyName;
                if (propertiesNode.data.children[ijj].text.toLowerCase() == nodeText.toLowerCase()) {
                  var properties = propertiesNode.data.children[ijj].properties;
                  properties.propertyName = nodeText;
                  //properties.keyType = 'assigned';
                  //properties.nullable = false;

                  /*newKeyNode = new Ext.tree.TreeNode({
                  text: nodeText,
                  type: "keyProperty",
                  leaf: true,
                  iconCls: 'treeKey',
                  hidden: false,
                  properties: properties
                  });*/
                  newKeyNode = {
                    text: nodeText,
                    type: "keyProperty",
                    leaf: true,
                    iconCls: 'treeKey',
                    hidden: false,
                    property: properties,
                    properties:properties
                  };
                  newKeyNode.iconCls = 'treeKey';
                  propertiesNode.data.children.splice(ijj, 1);
                  ijj--;

                  if (newKeyNode)
                  keysNode.appendChild(newKeyNode);
                  //keysNode.data.children.push(newKeyNode);

                  break;
                }
              }
            }
          }
          var nodeToDelete = [];  
          if(keysNode.childNodes.length > dataObject.keyProperties.length){
            for(var z = 0;z<keysNode.childNodes.length;z++){
              var availFlag = true;
              for(var x = 0; x< dataObject.keyProperties.length;x++){
                if(keysNode.childNodes[z].data.text == dataObject.keyProperties[x].keyPropertyName){
                  availFlag = false;
                }
              }
              if(availFlag)
              nodeToDelete.push(keysNode.childNodes[z]);
              //keysNode.childNodes.splice(z, 1);
            }
            for(var s = 0;s<nodeToDelete.length;s++){
              keysNode.childNodes.splice(s, 1);
              s--;
              nodeToDelete.length = nodeToDelete.length-1;
            }
          }

          // sync relationships
          for (var kj = 0; kj < dataObject.dataRelationships.length; kj++) {
            /*var newNode = new Ext.tree.TreeNode({
            text: dataObject.dataRelationships[kj].relationshipName,
            type: 'relationship',
            leaf: true,
            iconCls: 'treeRelation',
            relatedObjMap: [],
            objectName: dataObjectNode.text,
            relatedObjectName: dataObject.dataRelationships[kj].relatedObjectName,
            relationshipType: relationTypeStr[dataObject.dataRelationships[kj].relationshipType],
            relationshipTypeIndex: dataObject.dataRelationships[kj].relationshipType,
            propertyMap: []
            });
            */
            var newNode = {
              text: dataObject.dataRelationships[kj].relationshipName,
              type: 'relationship',
              leaf: true,
              iconCls: 'treeRelation',
              relatedObjMap: [],
              objectName: dataObjectNode.data.text,
              relatedObjectName: dataObject.dataRelationships[kj].relatedObjectName,
              relationshipType: relationTypeStr[dataObject.dataRelationships[kj].relationshipType],
              relationshipTypeIndex: dataObject.dataRelationships[kj].relationshipType,
              propertyMap: []
            };
            var mapArray = new Array();
            for (var kjj = 0; kjj < dataObject.dataRelationships[kj].propertyMaps.length; kjj++) {
              var mapItem = new Array();
              mapItem['dataPropertyName'] = dataObject.dataRelationships[kj].propertyMaps[kjj].dataPropertyName;
              mapItem['relatedPropertyName'] = dataObject.dataRelationships[kj].propertyMaps[kjj].relatedPropertyName;
              mapArray.push(mapItem);
            }
            newNode.iconCls = 'treeRelation';
            //newNode.attributes.propertyMap = mapArray;
            newNode.propertyMap = mapArray;  
            relationshipsNode.expanded = true;
            //relationshipsNode.children.push(newNode);
            relationshipsNode.appendChild(newNode);
            //relationshipsNode.data.children.push(newNode);

          }
        }
      }
      ijk++;
    }

    if (rootNode.childNodes.length == 1)
    if (rootNode.childNodes[0].text == "")
    rootNode.removeChild(rootNode.childNodes[0], true);
  },

  shown: function(shownArray, text) {
    /*alert('this is shown...');
    for (var shownIndex = 0; shownIndex < shownArray.length; shownIndex++)
    if (shownArray[shownIndex] == text)
    return true;
    return false;
    */
  }

});
