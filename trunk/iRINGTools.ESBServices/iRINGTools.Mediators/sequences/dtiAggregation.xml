<?xml version="1.0" encoding="UTF-8"?>
<proxy xmlns="http://ws.apache.org/ns/synapse" name="dtiAggregation" transports="https http" startOnLoad="true" trace="disable">
  <target>
    <inSequence>
      <log level="custom"><property name="DTI_AGG_IN" expression="*"/></log>
      <property name="endpointURLs" expression="fn:substring-after(get-property('To'), '?')" scope="default" type="STRING"/>
      <property name="DISABLE_CHUNKING" value="true" scope="axis2" type="BOOLEAN"/>      
      <clone>
        <target>
          <sequence>
            <header name="To" expression="fn:substring-before(fn:substring-after(get-property('endpointURLs'), 'sourceURL='), '&amp;')"/>
            <send/>
          </sequence>
        </target>
        <target>
          <sequence>
            <header name="To" expression="fn:substring-after(get-property('endpointURLs'), 'targetURL=')"/>
            <send/>
          </sequence>
        </target>
      </clone>
    </inSequence>
    <outSequence>
      <aggregate>
        <completeCondition>
          <messageCount min="-1" max="-1"/>
        </completeCondition>
        <onComplete xmlns:dti="http://www.iringtools.org/dxfr/dti" expression="//dti:dataTransferIndices">
          <script language="js"><![CDATA[
            var soapenv = new Namespace("http://schemas.xmlsoap.org/soap/envelope/");
            var payload = mc.getEnvelopeXML().soapenv::Body.*;                   
            mc.setPayloadXML(
              <m:dtiAggrResponse xmlns:m="http://wso2.org/response">
                {payload}
              </m:dtiAggrResponse>);
          ]]></script> 
          <log level="custom"><property name="DTI_AGG_OUT" expression="*"/></log>
          <send/>
        </onComplete>
      </aggregate>
    </outSequence>
  </target>
</proxy>
