<?xml version="1.0" encoding="UTF-8"?>
<proxy xmlns="http://ws.apache.org/ns/synapse" name="cloneAggregate" transports="https http" startOnLoad="true" trace="disable">
  <target>
    <inSequence>
      <log level="full"><property name="HERE" expression="get-property('targetUri')"/></log>
      <property name="DISABLE_CHUNKING" value="true" scope="axis2" type="BOOLEAN"/>
      <clone>
        <target>
          <sequence>
            <header name="To" value="http://localhost:54321/dto/12345_000/ABC/Lines/xfr"/>
            <send/>
          </sequence>
        </target>
        <target>
          <sequence>
            <header name="To" value="http://localhost:54321/dto/12345_000/DEF/Lines/xfr"/>
            <send/>
          </sequence>
        </target>
      </clone>
    </inSequence>
    <outSequence>
      <aggregate>
        <completeCondition>
          <messageCount min="-1" max="-1"/>
        </completeCondition>
        <onComplete xmlns:ns2="http://org.apache.synapse/xsd" xmlns:ns="http://org.apache.synapse/xsd" xmlns:soapenv="http://www.w3.org/2003/05/soap-envelope" xmlns:dti="http://www.iringtools.org/dxfr/dti" expression="//dti:dataTransferIndices">
          <script language="js"><![CDATA[
            var soapenv = new Namespace("http://schemas.xmlsoap.org/soap/envelope/");
            var payload = mc.getEnvelopeXML().soapenv::Body.*;                   
            mc.setPayloadXML(
              <m:dxiRequest xmlns:m="http://www.iringtools.org/dxfr/request">
               {payload}
              </m:dxiRequest>);
          ]]></script> 
          <send/>
        </onComplete>
      </aggregate>
    </outSequence>
  </target>
</proxy>
