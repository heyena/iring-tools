<Project DefaultTargets="Build" ToolsVersion="3.5" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets" />

  <PropertyGroup>
    <AssemblyInfoFile>$(MSBuildProjectDirectory)\AssemblyInfo.cs;</AssemblyInfoFile> <!--$(MSBuildProjectDirectory)\iRINGTools.SDK\AssemblyInfo.cs-->
    <Major>2</Major>
    <Minor>1</Minor>
    <Build>0</Build>
    <Revision>0</Revision>
  </PropertyGroup>

  <PropertyGroup>
    <MSTestCmd>"$(VSINSTALLDIR)\Common7\IDE\MSTest.exe"</MSTestCmd>
    <ZipCmd>"$(MSBuildProjectDirectory)\ExternalBinaries\7-Zip\7z.exe"</ZipCmd>
    <NUnit-ToolPath>C:\Program Files (x86)\NUnit 2.5.9\bin\net-2.0</NUnit-ToolPath>
    <ServicesDir>$(MSBuildProjectDirectory)\iRINGTools.Services</ServicesDir>
    <ApplicationsDir>$(MSBuildProjectDirectory)\iRINGTools.Applications</ApplicationsDir>
    <LandingPageDir>$(MSBuildProjectDirectory)\iRINGTools.Landing</LandingPageDir>
    <UtilitiesDir>$(MSBuildProjectDirectory)\Utilities</UtilitiesDir>
    <RDFImportExportDir>$(UtilitiesDir)\RDFImportExport\RDFImportExport</RDFImportExportDir>
    <QMXFGeneratorDir>$(UtilitiesDir)\QMXFGenerator</QMXFGeneratorDir>
    <FacadeExchangeDir>$(UtilitiesDir)\FacadeExchange</FacadeExchangeDir>
    <UnitTestsDir>$(MSBuildProjectDirectory)\UnitTests</UnitTestsDir>
    <AdapterServiceTestsDir>$(UnitTestsDir)\AdapterService.Tests</AdapterServiceTestsDir>
    <RefDataServiceTestsDir>$(UnitTestsDir)\ReferenceDataService.Tests</RefDataServiceTestsDir>
    <SDKDir>$(MSBuildProjectDirectory)\iRINGTools.SDK</SDKDir>
    <SDKLibDir>$(SDKDir)\lib</SDKLibDir>
    
    <DeploymentDir>$(MSBuildProjectDirectory)\Deployment</DeploymentDir>        
    <DistDir>c:\bamboo.iringtools.org\dist</DistDir>
    
    <ServicesDeploymentDir>$(DeploymentDir)\iRINGTools\Services</ServicesDeploymentDir>
    <AppsDeploymentDir>$(DeploymentDir)\iRINGTools\Apps</AppsDeploymentDir>
    <UtilitiesDeploymentDir>$(DeploymentDir)\iRINGTools\Utils</UtilitiesDeploymentDir>
    <LandingDeploymentDir>$(DeploymentDir)\iRINGTools</LandingDeploymentDir>
    <SDKDeploymentDir>$(DeploymentDir)\SDK</SDKDeploymentDir>
    <CSVDataLayerDeploymentDir>$(SDKDeploymentDir)\CSVDataLayer</CSVDataLayerDeploymentDir>
    <SDKLibDeploymentDir>$(SDKDeploymentDir)\lib\iring-tools</SDKLibDeploymentDir>

	<DevDeploymentDir>C:\iring-tools-web\dev.iringsandbox.org</DevDeploymentDir>
	
    <SolutionFile>iring-tools.sln</SolutionFile>
    <SDKSolutionFile>$(SDKDir)\iring-tools-sdk-express.sln</SDKSolutionFile>
  </PropertyGroup>

  <ItemGroup>
    <ServicesDeployment
      Include="$(ServicesDir)\**;"
      Exclude="$(ServicesDir).Tests\**;
             $(ServicesDir)\AdapterSettings.xml;
             $(ServicesDir)\KeyRing.xml;
             $(ServicesDir)\App_Code\**;
             $(ServicesDir)\App_Data\config_Developer.ttl;
             $(ServicesDir)\bin\*.pdb;
             $(ServicesDir)\obj\**;
             $(ServicesDir)\Properties\**;
             $(ServicesDir)\Logs\**;
             $(ServicesDir)\Templates\**;
             $(ServicesDir)\Transforms\**;
             $(ServicesDir)\obj\**;
             $(ServicesDir)\*.cs;
             $(ServicesDir)\*.csproj;
             $(ServicesDir)\*.user;
             $(ServicesDir)\*.vspscc;
             $(ServicesDir)\*.log;
             $(ServicesDir)\web.config;
             $(ServicesDir)\Service.cs;
             $(ServicesDir)\IService.cs;
             $(ServicesDir)\Global.asax.cs;
             $(ServicesDir)\XML\DataDictionary.*.xml;
             $(ServicesDir)\XML\DatabaseDictionary.*.xml;
             $(ServicesDir)\XML\nh-configuration.*.xml;
             $(ServicesDir)\XML\nh-mapping.*.xml;
             $(ServicesDir)\XML\Repositories.xml;
             $(ServicesDir)\XML\Scopes.xml;
             $(ServicesDir)\.svn\**;
             $(ServicesDir)\*\.svn\**;
             $(ServicesDir)\*\*\.svn\**;
             $(ServicesDir)\*\*\*\.svn\**;">
    </ServicesDeployment>

    <LandingDeployment
      Include="$(LandingPageDir)\**"
      Exclude="$(LandingPageDir)\.svn\**;
               $(LandingPageDir)\*\.svn\**;
	       $(LandingPageDir)\.settings\**;
               $(LandingPageDir)\.project;">
    </LandingDeployment>

    <AppsDeployment
      Include="$(ApplicationsDir)\**"
      Exclude="$(ApplicationsDir)\bin\*.pdb;
               $(ApplicationsDir)\obj\**;
               $(ApplicationsDir)\Properties\**;
               $(ApplicationsDir)\*.cs;
               $(ApplicationsDir)\*.csproj;
               $(ApplicationsDir)\*.user;
               $(ApplicationsDir)\*.vspscc;
               $(ApplicationsDir)\web.config;
               $(ApplicationsDir)\.svn\**;
               $(ApplicationsDir)\**\.svn\**;
               $(ApplicationsDir)\*\*\.svn\**;
			   $(ApplicationsDir)\*\*\*\.svn\**;
			   $(ApplicationsDir)\*\*\*\*\.svn\**;
			   $(ApplicationsDir)\*\*\*\*\*\.svn\**;
			   $(ApplicationsDir)\*\*\*\*\*\*\.svn\**;">
    </AppsDeployment>

    <UtilitiesDeployment
      Include="Libraries\iRINGLibrary\Desktop\bin\Debug\iRINGLibrary.dll;
               Libraries\iRINGLibrary\Desktop\bin\Debug\UtilityLibrary.dll;
               Utilities\EncryptCredentials\bin\Debug\EncryptCredentials.exe;
               Utilities\ConfigurationTool\bin\Debug\ConfigurationTool.exe;
               Utilities\RDFImportExport\RDFImportExport\bin\Debug\dotNetRDF.dll;
               Utilities\RDFImportExport\RDFImportExport\bin\Debug\dotNetRDF.xml;
               Utilities\RDFImportExport\RDFImportExport\bin\Debug\HtmlAgilityPack.dll;
               Utilities\RDFImportExport\RDFImportExport\bin\Debug\HtmlAgilityPack.xml;
               Utilities\RDFImportExport\RDFImportExport\bin\Debug\MySql.Data.dll;
               Utilities\RDFImportExport\RDFImportExport\bin\Debug\Newtonsoft.Json.dll;
               Utilities\RDFImportExport\RDFImportExport\bin\Debug\Newtonsoft.Json.xml;
               Utilities\RDFImportExport\RDFImportExport\bin\Debug\RDFImportExport.exe;
               Utilities\RDFImportExport\RDFImportExport\RDFImportExport_Default.config;
               Utilities\QMXFGenerator\bin\Debug\QMXFGenerator.exe;
               Utilities\QMXFGenerator\QMXFGenerator_Default.config;
               Utilities\QMXFGenerator\InformationModel.xls;
               Utilities\QMXFTransforms\*.dtd;
               Utilities\QMXFTransforms\*.xsd;
               Utilities\QMXFTransforms\*.xsl;
               Utilities\FacadeExchange\bin\Debug\FacadeExchange.exe;
               Utilities\FacadeExchange\App_Default.config;
               Utilities\FacadeExchange\bin\Debug\*.dll;
               Utilities\FacadeExchange\bin\Debug\*.xml;">
    </UtilitiesDeployment>

    <SDKDeployment
      Include="$(SDKDir)\**;"
      Exclude="$(SDKDir)\TestResults\**;
               $(SDKDir)\CSVDataLayer\bin\**;
               $(SDKDir)\CSVDataLayer\obj\**;
               $(SDKDir)\CSVDataLayer\12345_000.CSV.config;
               $(SDKDir)\CSVDataLayer\12345_000.CSV\Equipment\Equip-001.csv;
               $(SDKDir)\CSVDataLayer\12345_000.CSV\Equipment\Equip-002.csv;
               $(SDKDir)\CSVDataLayer\12345_000.CSV\Equipment\Equip-003.csv;
               $(SDKDir)\CSVDataLayer\12345_000.CSV\Equipment\Equip-004.csv;
               $(SDKDir)\lib\*.*;
               $(SDKDir)\.svn\**;
               $(SDKDir)\*\.svn\**;
               $(SDKDir)\*\*\.svn\**;
               $(SDKDir)\*\*\*\.svn\**;">                    
    </SDKDeployment>
    
    <SDKLib
      Include="Libraries\iRINGLibrary\Desktop\bin\Debug\iRINGLibrary.dll;
             Libraries\iRINGLibrary\Desktop\bin\Debug\UtilityLibrary.dll;">
    </SDKLib>

    <SDKLibLog4Net
      Include="ExternalBinaries\log4net\**;"
      Exclude="ExternalBinaries\*\.svn\**;
             ExternalBinaries\*\*\.svn\**;
             ExternalBinaries\*\*\*\.svn\**;">
    </SDKLibLog4Net>

    <SDKLibNinject2
      Include="ExternalBinaries\Ninject2\**;"
      Exclude="ExternalBinaries\*\.svn\**;
             ExternalBinaries\*\*\.svn\**;
             ExternalBinaries\*\*\*\.svn\**;">
    </SDKLibNinject2>

    <SDKLibConfiguration
      Include="ExternalBinaries\Configuration\**;"
      Exclude="ExternalBinaries\*\.svn\**;
             ExternalBinaries\*\*\.svn\**;
             ExternalBinaries\*\*\*\.svn\**;">
    </SDKLibConfiguration>

    <SDKLibFlee
      Include="ExternalBinaries\Flee-0.9.26.0\**;"
      Exclude="ExternalBinaries\*\.svn\**;
             ExternalBinaries\*\*\.svn\**;
             ExternalBinaries\*\*\*\.svn\**;">
    </SDKLibFlee>

    <SDKLibDeployment
      Include="ExternalBinaries\Flee-0.9.26.0\**;
             ExternalBinaries\Configuration\**;
             ExternalBinaries\Ninject2\**;
             ExternalBinaries\log4net\**;
             $(SDKLibDir)\**;">
    </SDKLibDeployment>
  </ItemGroup>

  <ItemGroup>
    <DeploymentPackage Include="*.*">
      <Options>a -tzip -y -r</Options>
      <OutputDir></OutputDir>
	  <ZipFile>$(DeploymentDir)\iRINGTools-$(Major).$(Minor).$(Build).zip</ZipFile>
	  <FileSet>$(ServicesDeploymentDir) $(AppsDeploymentDir) $(UtilitiesDeploymentDir) $(LandingDeploymentDir)\*</FileSet>
    </DeploymentPackage>
	<DeploymentPackage Include="*.*">
      <Options>x -tzip -y -o</Options>
	  <OutputDir>$(DevDeploymentDir)</OutputDir>
      <ZipFile>$(DeploymentDir)\iRINGTools-$(Major).$(Minor).$(Build).zip</ZipFile>
	  <FileSet></FileSet>
    </DeploymentPackage>
    <!--<DeploymentPackage Include="*" Exclude="">
      <Options>a -tzip -r</Options>
      <FileSet>$(SDKDeploymentDir)\*</FileSet>
      <ZipFile>$(DeploymentDir)\iRINGTools-SDK-$(Major).$(Minor).$(Build).zip</ZipFile>
    </DeploymentPackage>-->
  </ItemGroup>

  <Target Name="Version">
    <Message Text="Updating assembly info ..." />

    <SvnVersion LocalPath="$(MSBuildProjectDirectory)">
      <Output TaskParameter="Revision" PropertyName="Revision" />
    </SvnVersion>

    <FileUpdate
      Files="$(AssemblyInfoFile)"
      Regex="(\d+)\.(\d+)\.(\d+)(\.(\d+))*"
      ReplacementText="$(Major).$(Minor).$(Build).$(Revision)"/>
  </Target>

  <Target Name="SvnCleanUp">
    <Message Text="Performing SVN clean-up ..." />
    <Exec Command="svn cleanup"/>
  </Target>

  <Target Name="SvnUpdate">
    <Message Text="Performing SVN update ..." />
    <Exec Command="svn update"/>
  </Target>

  <Target Name="CleanBuild">
    <Message Text="Performing MSBuild clean-up ..." />
    <MSBuild Projects="$(SolutionFile)" Targets="Clean"/>
  </Target>
   
  <Target Name="PrepareBuild">
    <Message Text="Preparing build ..." />
    <Exec Condition="!Exists('$(ServicesDir)\Web.config')" 
          Command="Copy $(ServicesDir)\Web_Default.config $(ServicesDir)\Web.config" />
    <Exec Condition="!Exists('$(ServicesDir)\XML\Repositories.xml')" 
          Command="Copy $(ServicesDir)\\XML\Repositories_Default.xml $(ServicesDir)\XML\Repositories.xml" />
    <Exec Condition="!Exists('$(ServicesDir)\App_Data\config.ttl')" 
          Command="Copy $(ServicesDir)\App_Data\config_Default.ttl $(ServicesDir)\App_Data\config.ttl" />
    <Exec Condition="!Exists('$(ApplicationsDir)\Web.config')"
          Command="Copy $(ApplicationsDir)\Web_Default.config $(ApplicationsDir)\Web.config" />
    <Exec Condition="!Exists('$(FacadeExchangeDir)\App.config')"
      Command="Copy $(FacadeExchangeDir)\App_Default.config $(FacadeExchangeDir)\App.config" />
    <Exec Condition="!Exists('$(QMXFGeneratorDir)\App.config')"
          Command="Copy $(QMXFGeneratorDir)\QMXFGenerator_Default.config $(QMXFGeneratorDir)\App.config" />
    <Exec Condition="!Exists('$(RDFImportExportDir)\App.config')"
          Command="Copy $(RDFImportExportDir)\RDFImportExport_Default.config $(RDFImportExportDir)\App.config" />
  </Target>

  <Target Name="CoreBuild" DependsOnTargets="Version">
    <Message Text="Performing MSBuild ..." />
    <MSBuild Projects="$(SolutionFile)" Targets="Build"/>
  </Target>

  <Target Name="SDKBuild" DependsOnTargets="DeployToSDK">
    <Message Text="Performing MSBuild of SDK ..." />
    <MSBuild Projects="$(SDKSolutionFile)" Targets="Build"/>
  </Target>

    <Target Name="Test">
        <NUnit ToolPath="$(NUnit-ToolPath)" DisableShadowCopy="true" Assemblies="Tests\NUnit.Tests\Bin\NUnit.Tests.dll" OutputXmlFile="test-results.xml" />
	</Target>

  <Target Name="CreateDeployment">
    <Message Text="Cleaning up old deployment folders..." />
    <Exec Command="RmDir /S /Q $(DeploymentDir)" />
    <MakeDir Directories="$(ServicesDeploymentDir); $(AppsDeploymentDir); $(LandingDeploymentDir); $(UtilitiesDeploymentDir);"/>
    <!--<Exec Command="Copy .\ClientAccessPolicy.xml $(ServicesDeploymentDir)\ClientAccessPolicy.xml" />
    <Exec Command="Copy .\ClientAccessPolicy.xml $(AppsDeploymentDir)\ClientAccessPolicy.xml" />-->

    <Message Text="Creating Services deployment ..." />
    <Copy SourceFiles="@(ServicesDeployment)"
          DestinationFiles="@(ServicesDeployment ->'$(ServicesDeploymentDir)\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Exec Command="Move /Y $(ServicesDeploymentDir)\Web_Default.config $(ServicesDeploymentDir)\Web.config" />
    <Exec Command="Move /Y $(ServicesDeploymentDir)\XML\Repositories_Default.xml $(ServicesDeploymentDir)\XML\Repositories.xml" />
    <Exec Command="Move /Y $(ServicesDeploymentDir)\App_Data\Config_Default.ttl $(ServicesDeploymentDir)\App_Data\Config.ttl" />
    <Exec Command="Mkdir $(ServicesDeploymentDir)\Logs" />
    <Exec Command="Mkdir $(ServicesDeploymentDir)\App_Code"/>

    <Message Text="Creating Applications deployment ..." />
    <Copy SourceFiles="@(AppsDeployment)"
          DestinationFiles="@(AppsDeployment->'$(AppsDeploymentDir)\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Exec Command="Move /Y $(AppsDeploymentDir)\Web_Default.config $(AppsDeploymentDir)\Web.config" />

    <Message Text="Creating Utilities deployment ..." />
    <Copy SourceFiles="@(UtilitiesDeployment)"
          DestinationFiles="@(UtilitiesDeployment->'$(UtilitiesDeploymentDir)\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Exec Command="Move /Y $(UtilitiesDeploymentDir)\App_Default.config $(UtilitiesDeploymentDir)\FacadeExchange.exe.config" />
    <Exec Command="Move /Y $(UtilitiesDeploymentDir)\QMXFGenerator_Default.config $(UtilitiesDeploymentDir)\QMXFGenerator.exe.config" />
    <Exec Command="Move /Y $(UtilitiesDeploymentDir)\RDFImportExport_Default.config $(UtilitiesDeploymentDir)\RDFImportExport.exe.config" />

    <Message Text="Creating landing page deployment ..." />
    <Copy SourceFiles="@(LandingDeployment)"
          DestinationFiles="@(LandingDeployment->'$(LandingDeploymentDir)\%(RecursiveDir)%(Filename)%(Extension)')" />

    <!--<Message Text="Creating SDK deployment ..." />
    <Copy SourceFiles="@(SDKDeployment)"
          DestinationFiles="@(SDKDeployment->'$(SDKDeploymentDir)\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Exec Command="Move /Y $(SDKDeploymentDir)\CSVDataLayer\12345_000.CSV_Default.config $(SDKDeploymentDir)\CSVDataLayer\12345_000.CSV.config" />

    <Message Text="Creating SDK library deployment ..." />
    <Copy SourceFiles="@(SDKLib)"
          DestinationFiles="@(SDKLib ->'$(SDKLibDeploymentDir)\iring-tools\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(SDKLibLog4Net)"
          DestinationFiles="@(SDKLibLog4Net ->'$(SDKLibDeploymentDir)\log4net\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(SDKLibNinject2)"
          DestinationFiles="@(SDKLibNinject2 ->'$(SDKLibDeploymentDir)\ninject2\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(SDKLibConfiguration)"
          DestinationFiles="@(SDKLibConfiguration ->'$(SDKLibDeploymentDir)\configuration\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(SDKLibFlee)"
          DestinationFiles="@(SDKLibFlee ->'$(SDKLibDeploymentDir)\flee-0.9.26.0\%(RecursiveDir)%(Filename)%(Extension)')" />-->
  </Target>

  <Target Name="DeployToSDK">
   
    <Message Text="Deploying to SDK library ..." />
    <Copy SourceFiles="@(SDKLib)"
          DestinationFiles="@(SDKLib ->'$(SDKLibDir)\iring-tools\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(SDKLibLog4Net)"
          DestinationFiles="@(SDKLibLog4Net ->'$(SDKLibDir)\log4net\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(SDKLibNinject2)"
          DestinationFiles="@(SDKLibNinject2 ->'$(SDKLibDir)\ninject2\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(SDKLibConfiguration)"
          DestinationFiles="@(SDKLibConfiguration ->'$(SDKLibDir)\configuration\%(RecursiveDir)%(Filename)%(Extension)')" />
    <Copy SourceFiles="@(SDKLibFlee)"
          DestinationFiles="@(SDKLibFlee ->'$(SDKLibDir)\flee-0.9.26.0\%(RecursiveDir)%(Filename)%(Extension)')" />
  </Target>

  <Target Name="CreatePackages" >
    <Exec Command="$(zipCmd) %(DeploymentPackage.Options)%(OutputDir) %(DeploymentPackage.ZipFile) %(DeploymentPackage.FileSet)" />
  </Target>

  <Target Name="Build" DependsOnTargets="CoreBuild;"/>

  <Target Name="Rebuild" DependsOnTargets="CleanBuild; PrepareBuild; CoreBuild;"/>
  
  <Target Name="Distribute">
    <Copy SourceFiles="$(DeploymentDir)\iRINGTools-$(Major).$(Minor).$(Build).zip" 
          DestinationFiles="$(DistDir)\iRINGTools-Adapter.zip">
    </Copy>
    <!--<Copy SourceFiles="$(DeploymentDir)\iRINGTools-SDK-$(Major).$(Minor).$(Build).zip" 
          DestinationFiles="$(DistDir)\iRINGTools-SDK.zip">
    </Copy>-->
  </Target>

  <Target Name="All" DependsOnTargets="Rebuild; Test; CreatePackages; Distribute"/>
</Project>