<?xml version="1.0" encoding="UTF-8"?>
<sequence xmlns="http://ws.apache.org/ns/synapse" xmlns:dti="http://www.iringtools.org/dxfr/dti" xmlns:dto="http://www.iringtools.org/dxfr/dto" name="exchangePoolIn">
	<log level="custom">
		<property name="EXCHANGE_POOL_IN" expression="*" />
	</log>
	
  <property name="sourceUri" expression="//xpr:sourceUri" xmlns:xpr="http://wso2.org/request"/>
	<property name="targetUri" expression="//xpr:targetUri" xmlns:xpr="http://wso2.org/request"/>
	<property name="isReviewed" xmlns:xpr="http://wso2.org/request" xmlns:xreq="http://www.iringtools.org/dxfr/request" expression="//xpr:exchangePoolRequest/xpr:exchangeRequest/xreq:reviewed" type="BOOLEAN"/>
  <property name="manifest" xmlns:xpr="http://wso2.org/request" xmlns:xreq="http://www.iringtools.org/dxfr/request" expression="//xpr:exchangePoolRequest/xpr:manifest"/>
  
  <property name="DISABLE_CHUNKING" value="true" scope="axis2" type="BOOLEAN" />
	
  <!--<script language="js"><![CDATA[
    var xpr = new Namespace("http://wso2.org/request");
    var xreq = new Namespace("http://www.iringtools.org/dxfr/request");
    var dti = new Namespace("http://www.iringtools.org/dxfr/dti");
    var payload = mc.getPayloadXML();
    var indices = payload.xpr::exchangePoolRequest.xpr::exchangeRequest.xreq::dataTransferIndices.dti::dataTransferIndexList.dti::dataTransferIndex;
    for each (var index in indices) {
      value += stringValue(c);
    }
  ]]></script>-->
    
	<iterate xmlns:xpr="http://wso2.org/request" xmlns:xreq="http://www.iringtools.org/dxfr/request" expression="//xpr:exchangePoolRequest/xpr:exchangeRequest/xreq:dataTransferIndices/dti:dataTransferIndexList/dti:dataTransferIndex">
		<target>
			<sequence>        
        <switch source="//dti:transferType">
          <case regex="Add|Change">
            <script language="js"><![CDATA[
              var manifest = new XML(mc.getProperty('manifest'));
              var dataTransferIndex = mc.getPayloadXML();
              mc.setPayloadXML(
                <req:dtoPageRequest xmlns:req="http://www.iringtools.org/dxfr/request">
                  <req:manifest xmlns="http://www.iringtools.org/dxfr/manifest">{manifest.*}</req:manifest>
                  <req:dataTransferIndices xmlns="http://www.iringtools.org/dxfr/dti">
                    <dataTransferIndexList>{dataTransferIndex}</dataTransferIndexList>
                  </req:dataTransferIndices>
                </req:dtoPageRequest>);
            ]]></script>
            
            <property name="REST_URL_POSTFIX" expression="fn:concat(get-property('sourceUri'), '/xfr/page')" scope="axis2" />
            <send>
              <endpoint>
                <address uri="" format="rest" />
              </endpoint>
            </send>
            
            <!--<filter source="get-property('isReviewed')" regex="true">
              <then>
                <property name="hash" value="recalculate hash (custom mediator)"/>
              </then>
            </filter>-->
          </case>
          <!--<case regex="Delete">  
            <script language="js"><![CDATA[
              var dti = new Namespace("http://www.iringtools.org/dxfr/dti");
              var identifier = mc.getPayloadXML().dti::identifier;
              mc.setPayloadXML(
                <dataTransferObjects xmlns="http://www.iringtools.org/dxfr/dto">
                  <dataTransferObjectList><dataTransferObject>{identifier}<transferType>Delete</transferType></dataTransferObject></dataTransferObjectList>
                </dataTransferObjects>);
            ]]></script>
            <log level="custom">
              <property name="DELETE_DTO" expression="*" />
            </log>
            <property name="RESPONSE" value="true" />
            <header name="To" action="remove" />
            <send />
          </case>-->
        </switch>         
      </sequence>
		</target>
	</iterate>
</sequence>
